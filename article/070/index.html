<!-- 
          _____                   _______                   _____          
          /\    \                 /::\    \                 /\    \         
         /::\    \               /::::\    \               /::\    \        
        /::::\    \             /::::::\    \             /::::\    \       
       /::::::\    \           /::::::::\    \           /::::::\    \      
      /:::/\:::\    \         /:::/~~\:::\    \         /:::/\:::\    \     
     /:::/__\:::\    \       /:::/    \:::\    \       /:::/__\:::\    \    
    /::::\   \:::\    \     /:::/    / \:::\    \     /::::\   \:::\    \   
   /::::::\   \:::\    \   /:::/____/   \:::\____\   /::::::\   \:::\    \  
  /:::/\:::\   \:::\ ___\ |:::|    |     |:::|    | /:::/\:::\   \:::\ ___\ 
 /:::/__\:::\   \:::|    ||:::|____|     |:::|    |/:::/__\:::\   \:::|    |
 \:::\   \:::\  /:::|____| \:::\    \   /:::/    / \:::\   \:::\  /:::|____|
  \:::\   \:::\/:::/    /   \:::\    \ /:::/    /   \:::\   \:::\/:::/    / 
   \:::\   \::::::/    /     \:::\    /:::/    /     \:::\   \::::::/    /  
    \:::\   \::::/    /       \:::\__/:::/    /       \:::\   \::::/    /   
     \:::\  /:::/    /         \::::::::/    /         \:::\  /:::/    /    
      \:::\/:::/    /           \::::::/    /           \:::\/:::/    /     
       \::::::/    /             \::::/    /             \::::::/    /      
        \::::/    /               \::/____/               \::::/    /       
         \::/____/                 ~~                      \::/____/        
          ~~                                                ~~              
                                                                            
                                WWW.ITBOB.CN
                                
                        有毛的叫程序猿，沒毛的叫程序员。
-->

<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Force https -->

    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


<!-- Title -->
<title>抖音滑块验证码 captchaBody 逆向分析，JSVMP 纯算法还原 - BOB&#39;S BLOG</title>

<!-- Icon -->
<link rel="icon" href="/img/favicon.ico">

<!-- Fonts -->
<link rel="preload" href="//fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" as="style" onload="this.onload=null, this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="//fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript>

<!-- Font Awesome -->
<!-- https://fontawesome.dashgame.com/ -->
<!-- <link rel="stylesheet" href="https://cdn.itbob.cn/css/font-awesome@5.6.3/all.min.css"> -->
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/5.15.4/css/all.min.css">
<!-- <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css"> -->


    <!-- KaTeX -->
    <!-- //cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css -->
    <link rel="preload" href="//cdn.itbob.cn/css/katex@0.12.0/katex.min.css" as="style" onload="this.onload=null, this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="//cdn.itbob.cn/css/katex@0.12.0/katex.min.css"></noscript>


<!-- Style -->

<link rel="stylesheet" href="/styles/main.css">

<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-theme-pure@1.0.1/dist/main.css"> -->

<!-- Analytics -->

    
    
        <!-- Baidu Analytics -->
        <script defer>
            var _hmt = _hmt || [];
            (function () {
                var hm = document.createElement('script');
                hm.src = 'https://hm.baidu.com/hm.js?6ca34ddce088f8434f3c7509576819f2';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    


<!-- Busuanzi -->
<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
<script async src="//cdn.itbob.cn/js/busuanzi@2.3/busuanzi.pure.mini.js"></script>

<!-- Typeit -->
<!-- https://www.typeitjs.com/ -->
<script src="//unpkg.com/typeit@8.7.0/dist/index.umd.js"></script>

<!-- Fancybox -->

    <link rel="stylesheet" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css">
    <script src="//cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js"> </script>
    <script src="//cdn.itbob.cn/js/fancybox@3.5.7/fancybox.js"> </script>

<!-- <script>
  $('[data-fancybox="images"]').fancybox({//可选
    thumbs : {
      autoStart : true //缩略图
    }
  });
  $('[data-fancybox]').fancybox({//启用函数，必须
    protect: true //图片右键不能下载，可选
  });
</script> -->

<!-- Console -->
<script>
    function makeMulti (string) {
        let l = new String(string)
        l = l.substring(l.indexOf("/*") + 3, l.lastIndexOf("*/"))
        return l
    }
    let string = function () {
      /* 
          _____                   _______                   _____          
          /\    \                 /::\    \                 /\    \         
         /::\    \               /::::\    \               /::\    \        
        /::::\    \             /::::::\    \             /::::\    \       
       /::::::\    \           /::::::::\    \           /::::::\    \      
      /:::/\:::\    \         /:::/~~\:::\    \         /:::/\:::\    \     
     /:::/__\:::\    \       /:::/    \:::\    \       /:::/__\:::\    \    
    /::::\   \:::\    \     /:::/    / \:::\    \     /::::\   \:::\    \   
   /::::::\   \:::\    \   /:::/____/   \:::\____\   /::::::\   \:::\    \  
  /:::/\:::\   \:::\ ___\ |:::|    |     |:::|    | /:::/\:::\   \:::\ ___\ 
 /:::/__\:::\   \:::|    ||:::|____|     |:::|    |/:::/__\:::\   \:::|    |
 \:::\   \:::\  /:::|____| \:::\    \   /:::/    / \:::\   \:::\  /:::|____|
  \:::\   \:::\/:::/    /   \:::\    \ /:::/    /   \:::\   \:::\/:::/    / 
   \:::\   \::::::/    /     \:::\    /:::/    /     \:::\   \::::::/    /  
    \:::\   \::::/    /       \:::\__/:::/    /       \:::\   \::::/    /   
     \:::\  /:::/    /         \::::::::/    /         \:::\  /:::/    /    
      \:::\/:::/    /           \::::::/    /           \:::\/:::/    /     
       \::::::/    /             \::::/    /             \::::::/    /      
        \::::/    /               \::/____/               \::::/    /       
         \::/____/                 ~~                      \::/____/        
          ~~                                                ~~              
                                                                            
                                WWW.ITBOB.CN
                                
                        有毛的叫程序猿，沒毛的叫程序员。
      */
    }
    console.log(makeMulti(string));
    console.log("\n %c © ITBOB'S BLOG %c https://www.itbob.cn %c © ITRHX'S BLOG %c https://www.itrhx.com \n", "color: #fadfa3; background: #030307; padding:5px 0;", "background: #fadfa3; padding:5px 0;", "color: #fadfa3; background: #030307; padding:5px 0;", "background: #fadfa3; padding:5px 0;")
</script>

    <meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="BOB'S BLOG" type="application/atom+xml">
</head>
    <body>
        <div class="main gt-bg-theme-color-first">
            <div class="main-content">
                <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/img/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first" id="typeitspan">
            <!-- BOB&#39;S BLOG -->
        </div>
    </a>
    <!-- <span id="typeitspan"></span> -->
    <script>
        new TypeIt('#typeitspan', {
        strings: "BOB'S BLOG",
        speed: 150, 
        afterComplete: function (instance) {
            instance.destroy();
        }
        }).go();
    </script>
    <button aria-label="Navbar Toggler" class="navbar-toggler" type="button" id="changeNavbar">
        <i class="gt-c-content-color-first" style="font-size: 18px;">
            <svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 448 512" height="18px" fill="currentColor">
                <path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z" />
            </svg>
        </i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center; ">
            
                
                    <div class="nav-item">
                        <a href="/" class="menu gt-a-link" target="_self">首页</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/archives/" class="menu gt-a-link" target="_self">归档</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/tags/" class="menu gt-a-link" target="_self">标签</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/friends/" class="menu gt-a-link" target="_self">友链</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/about/" class="menu gt-a-link" target="_self">关于</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="https://travellings.link" target="_blank">
                            <img src="https://cdn.itbob.cn/img/travelling.gif" class="nofancybox" alt="开往-友链接力" width="auto" height="25px">
                        </a>
                    </div>
                
            
        </div>
    </div>
</nav>

<script>
    /* 移动端导航栏展开/收起切换 */
    document.getElementById('changeNavbar').onclick = function() {
        let element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else { 
            element.style.display = 'none';
        }
    }
</script>

                <div class="post-container">
    <div class="post-detail gt-bg-theme-color-second gt-c-content-color-first">
        <article class="gt-post-content">
            <h1 class="post-title">抖音滑块验证码 captchaBody 逆向分析，JSVMP 纯算法还原</h1>
            <div class="post-info">
                <time class="post-time gt-c-content-color-first">
                    <i class="fa fa-calendar-alt"></i> 首发于: 2023-05-04丨
                </time>
                <span id="busuanzi_container_page_pv">
                    <i class="fas fa-eye"></i> 阅读量: <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>丨
                </span>
                
                    <span class="post-count">
                        <i class="fa fa-keyboard"></i> 字数统计: 6k丨
                    </span>
                    <span class="post-count">
                        <i class="fa fa-hourglass-half"></i> 阅读时长: 25分丨
                    </span>
                
                
                    
                        <!-- <i class="fa fa-tag"></i> -->
                        <i class="fas fa-hashtag"></i>
                        <a href="/tags/%E7%88%AC%E8%99%AB/" class="post-tag">
                            爬虫</a>
                    
                        <!-- <i class="fa fa-tag"></i> -->
                        <i class="fas fa-hashtag"></i>
                        <a href="/tags/%E9%AA%8C%E8%AF%81%E7%A0%81%E9%80%86%E5%90%91%E5%AE%9E%E6%88%98/" class="post-tag">
                            验证码逆向实战</a>
                    
                
            </div>
            <hr>
            <div class="post-content gt-c-content-color-first">
                <p><img src="https://cdn.itbob.cn/img/cover/captcha_reverse.png" alt="captcha_reverse"></p>
<h2><span id="wen-zhang-mu-lu">文章目录</span></h2>
<hr>
<!-- toc -->
<ul>
<li><a href="#sheng-ming">声明</a></li>
<li><a href="#mu-biao">目标</a></li>
<li><a href="#zhua-bao-qing-kuang">抓包情况</a></li>
<li><a href="#can-shu-ni-xiang">参数逆向</a>
<ul>
<li><a href="#fp">fp</a></li>
<li><a href="#captchabody">captchaBody</a>
<ul>
<li><a href="#san-ge-shu-zu">三个数组</a></li>
<li><a href="#shu-zu-2-32-wei">数组 2（32位）</a></li>
<li><a href="#shu-zu-3-shang-qian-wei">数组 3（上千位）</a></li>
</ul>
</li>
<li><a href="#gui-ji-sheng-cheng">轨迹生成</a></li>
</ul>
</li>
<li><a href="#jie-guo-yan-zheng">结果验证</a></li>
</ul>
<!-- tocstop -->
<hr>
<h2><span id="sheng-ming">声明</span></h2>
<p><strong><font color="red">本文章中所有内容仅供学习交流使用，不用于其他任何目的，不提供完整代码，抓包内容、敏感网址、数据接口等均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关！</font></strong></p>
<p><strong><font color="red">本文章未经许可禁止转载，禁止任何修改后二次传播，擅自使用本文讲解的技术而导致的任何意外，作者均不负责，若有侵权，请通过邮件 <a href="mailto:admin@itbob.cn">admin@itbob.cn</a> 联系我立即删除！</font></strong></p>
<h2><span id="mu-biao">目标</span></h2>
<ul>
<li>目标：字节系滑块验证码，某音、某店、某头条、某量算数、某瓜视频等通用，captchaBody 参数逆向分析，JSVMP 纯算法还原</li>
<li>主页：<code>aHR0cHM6Ly9meGcuamlucml0ZW1haS5jb20v</code></li>
</ul>
<p>字节的滑块参数也是 VMP，和某音的 <code>X-Bogus</code> 类似的，<strong>本文有些细节就不再重复描述了</strong>，有不了解的推荐先看看以前的文章：《<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/SsZ4XWRXBeqx9VQEeKDsJA">【JS 逆向百例】某音 X-Bogus 逆向分析，JSVMP 纯算法还原</a>》，验证码有个 <code>fp</code> 参数，这个参数过了验证码之后，重命名为 <code>s_v_web_id</code> 加到 cookie 里去请求，就可以不带 <code>X-Bogus</code> 拿数据。<strong>本文的案例以某店的登录为例对验证码进行逆向分析。</strong></p>
<h2><span id="zhua-bao-qing-kuang">抓包情况</span></h2>
<p><code>send_activation_code/v2</code> 接口，请求参数包含了加密后的手机号、<code>aid</code> 等参数，其中 <code>aid</code> 应该是用来区分不同网站的，每个网站都不一样，<code>msToken</code>、<code>X-Bogus</code> 参数在这里不校验，置空就行。</p>
<p>返回的 <code>verify_center_decision_conf</code> 里，有 <code>detail</code> 等值，后续接口会用到。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/01.png" alt="01"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/02.png" alt="02"></p>
<p><code>captcha/get</code> 接口，请求参数里包含前面接口返回的 <code>detail</code>、<code>server_sdk_env</code> 等参数，<code>fp</code> 参数可通过 JS 生成，后续会讲怎么来的。返回数据里包含了验证码图片 URL、<code>challenge_code</code>、<code>id</code>、<code>tip_y</code> 等参数，这些后续同样也会用到的。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/03.png" alt="03"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/04.png" alt="04"></p>
<p><code>captcha/verify</code> 接口，提交验证，<code>xx-tt-dd</code> 为定值，<code>captchaBody</code> 是重点，通过 vmp 将轨迹等参数进行了加密处理，返回值 code 为 200 则表示通过。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/05.png" alt="05"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/06.png" alt="06"></p>
<h2><span id="can-shu-ni-xiang">参数逆向</span></h2>
<p>其他参数没啥可讲的，很简单，这里讲一下 <code>fp</code> 和 <code>captchaBody</code>。</p>
<h3><span id="fp">fp</span></h3>
<p><code>fp</code> 参数可以下个 XHR 断点，然后往前跟栈，栈可能有点多，但可以发现主要逻辑都在 <code>captcha.js</code> 里，同时 <code>fp</code> 参数前面有固定字符串 <code>verify_</code>，所以可以直接搜索这个字符串就能找到生成的位置。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/07.png" alt="07"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/08.png" alt="08"></p>
<pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">k</span>(<span class="hljs-params"></span>) </span>&#123;
    <span class="hljs-keyword">var</span> e = <span class="hljs-string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span>.split(<span class="hljs-string">&quot;&quot;</span>)
    , t = e.length
    , n = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>).getTime().toString(<span class="hljs-number">36</span>)
    , r = [];
    r[<span class="hljs-number">8</span>] = r[<span class="hljs-number">13</span>] = r[<span class="hljs-number">18</span>] = r[<span class="hljs-number">23</span>] = <span class="hljs-string">&quot;_&quot;</span>,
        r[<span class="hljs-number">14</span>] = <span class="hljs-string">&quot;4&quot;</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> o, i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">36</span>; i++)
        r[i] || (o = <span class="hljs-number">0</span> | <span class="hljs-built_in">Math</span>.random() * t,
                 r[i] = e[<span class="hljs-number">19</span> == i ? <span class="hljs-number">3</span> &amp; o | <span class="hljs-number">8</span> : o]);
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;verify_&quot;</span> + n + <span class="hljs-string">&quot;_&quot;</span> + r.join(<span class="hljs-string">&quot;&quot;</span>)
&#125;</code></pre>
<p>除此之外，前面已经提到过了，cookie 里的 <code>s_v_web_id</code> 值也就是 <code>fp</code> 的值，所以还可以通过 Hook cookie 的方法来快速定位。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/09.png" alt="09"></p>
<h3><span id="captchabody">captchaBody</span></h3>
<p><code>captchaBody</code> 是字节滑块的重点，跟栈可以发现主要逻辑在 <code>captcha.js</code> 里。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/10.png" alt="10"></p>
<p>从最后一个 <code>captcha.js</code> 的栈开始，也就是 send 方法这里，可以看到 f 就是 <code>captchaBody</code>，如下图所示：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/11.png" alt="11"></p>
<p>再往上走几步，就可以看到和 <code>X-Bogus</code> 一毛一样的 VMP 了，下图中的 w 就有 <code>captchaBody</code> 的值：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/12.png" alt="12"></p>
<p>然后就正式进入插桩找逻辑的流程了，和之前 <code>X-Bogus</code> 一样，在两个大的 if 这里下日志断点：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/13.png" alt="13"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/14.png" alt="14"></p>
<p>这里就有很多细节了，首先是为什么这么多 <code>if</code>、<code>return undefined</code>，这是为了防止循环引用导致异常，有异常日志就不能正常输出，导致缺失一部分日志，下图可以解释这一现象：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/15.png" alt="15"></p>
<p>还有就是我怎么知道 <code>key == '13'</code> 等等就会发生异常呢？当然一开始并不知道，不加这些 if，在控制台会看到一些报错，每一个报错修复一下就多了这些 if 判断了。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/16.png" alt="16"></p>
<p>关于这个日志断点的写法，之前 <code>X-Bogus</code> 的文章有非常详细的介绍，当然这个写法多种多样的，可能还有更优的写法，能实现目标就行，这里就不再啰嗦了。</p>
<p>还有一个细节就是 <code>位置 2-1</code> 和 <code>位置 2-2</code>，通过调试、观察、搜索可以发现 VMP 一共有七处，在不知道到底在哪个 VMP 生成 <code>captchaBody</code> 的情况下，可以在这七个地方都下日志断点，分别用位置 1 至 7 来区分。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/17.png" alt="17"></p>
<p>当然也不能太死板，日志太多了也不好，比如第三个 VMP 的第二个 if 语句，也就是 <code>位置 3-2</code> 这里，日志会巨多，会给你卡死，这种就不要输出了，经过调试，大多数的逻辑在 <code>位置 7-2</code>，可以先从这里开始看。</p>
<p>滑动验证码，等待日志输出完毕，搜索 <code>captchaBody</code> 的值，看看第一次出现的位置是哪里，这里又双叒叕得注意，由于日志内容太长，控制台会自动折叠一部分，即便你右键 save 日志，折叠的部分也是没有的，在搜索的时候，折叠部分也不在搜索范围内，所以我们需要把折叠的展开，才能正确找到第一次出现的地方！</p>
<p>如下图所示，没展开之前搜索结果 34 个，第一次出现的位置是 <code>位置 7-2 索引C 0 索引S 2952 值w</code>：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/18.png" alt="18"></p>
<p>展开之后搜索结果 63 个，第一次出现的位置是 <code>位置 7-2 索引C 10 索引S 2876 值w</code>，这个位置才是正确的地方：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/19.png" alt="19"></p>
<p>注意啦，这个索引值，有可能并不是每个人都一样的，但按道理来讲只要 JS 文件一样，断点一样，这些索引值应该也是一样的，我这里的 JS 版本为：<a target="_blank" rel="noopener" href="https://lf-cdn-tos.bytescm.com/obj/static/secsdk-captcha/cn2/2.26.17/captcha.js">https://lf-cdn-tos.bytescm.com/obj/static/secsdk-captcha/cn2/2.26.17/captcha.js</a></p>
<p>后续还是老套路，<strong>依次往上找每个值的第一次出现的位置，在相应的索引处下条件断点，然后单步跟逻辑</strong>，把每个参数都理清楚就行了，步骤有点多，后续我就直接展示最关键的步骤了，不需要什么高级技能，最重要的就是细心+耐心！</p>
<h4><span id="san-ge-shu-zu">三个数组</span></h4>
<p><code>位置 7-2 索引C 10 索引S 2876 值w</code>：第一次出现 captchaBody。</p>
<p><code>位置 7-2 索引C 4 索引S 2874 值w</code>：一个 Uint8Array 数组，先经过 <code>String.fromCharCode()</code> 方法将其转换为字符，再经过 <code>window.btoa()</code> 方法，也就是 base64 生成 captchaBody，我们将该数组称为<strong>数组 A</strong>。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/20.png" alt="20"></p>
<p><code>位置 7-2 索引C 28 索引S 2792 值w</code>： 第一次出现完整 Uint8Array 数组 A。</p>
<p><code>位置 7-2 索引C 16 索引S 2790 值w</code>：两个 Uint8Array 数组合并组成数组 A。其中一个数组前 38 位有值，剩下的都是 0 填充，如下图所示的 g 值，另一个数组长度不一定，但通常是好几千，如下图所示的 m 值，我们将其称为<strong>数组 3</strong>。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/21.png" alt="21"></p>
<p><code>位置 7-2 索引C 16 索引S 2750 值w</code>：两个 Uint8Array 数组合并组成上一步的 38 位数组，其中一个数组前 6 位有值，且为定值，剩下的都是 0 填充，如下图所示的 g 值，我们将其称为<strong>数组 1</strong>，另一个数组长度 32 位，如下图所示的 m 值，我们将其称为<strong>数组 2</strong>。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/22.png" alt="22"></p>
<p>这段步骤附上我的分析日志：</p>
<pre><code class="hljs yaml"><span class="hljs-string">======================================</span> <span class="hljs-string">合并数组</span> <span class="hljs-number">1</span><span class="hljs-string">、2、3</span> <span class="hljs-string">======================================</span>

<span class="hljs-string">数组</span> <span class="hljs-number">1</span> <span class="hljs-string">为定值：[116,</span> <span class="hljs-number">99</span><span class="hljs-string">,</span> <span class="hljs-number">6</span><span class="hljs-string">,</span> <span class="hljs-number">16</span><span class="hljs-string">,</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-number">0</span><span class="hljs-string">]</span>

<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">2750</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">合并第1和第2数组</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">2790</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">合并第2和第3数组</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">28</span> <span class="hljs-string">索引S</span> <span class="hljs-number">2792</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现完整大数组</span> <span class="hljs-string">A</span>


<span class="hljs-string">======================================</span> <span class="hljs-string">生成</span> <span class="hljs-string">captchaBody</span> <span class="hljs-string">======================================</span>

<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">4</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">2874</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">E(大数组</span> <span class="hljs-string">A)</span> <span class="hljs-string">=&gt;</span> <span class="hljs-string">btoa(大数组)</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">10</span> <span class="hljs-string">索引S</span> <span class="hljs-number">2876</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现</span> <span class="hljs-string">captchaBody</span></code></pre>
<p><strong>总结一下三个数组处理逻辑：</strong></p>
<pre><code class="hljs text">数组 1：6 位，定值 [116, 99, 6, 16, 0, 0]；

数组 2：32 位；

数组 3：数组长度不一定，但通常是好几千；

数组 A：由 数组1 + 数组2 + 数组3 组成；

captchaBody：由数组 A 先经过 String.fromCharCode() 方法转换为字符，再由 base64 编码得到。</code></pre>
<p>数组 1 是定值，所以接下来只需要查找数组 2、3 是怎么来的就行了。</p>
<h4><span id="shu-zu-2-32-wei">数组 2（32位）</span></h4>
<p>先看数组 2，也就是 32 位的这个数组怎么来的。</p>
<p><code>位置 7-2 索引C 29 索引S 2526 值w</code>：第一次出现数组 2。</p>
<p><code>位置 7-2 索引C 4  索引S 2524 值w</code>：将一个 32 位长度的字符串，每一个字符转换成对应的 Unicode 编码，得到数组 2。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/23.png" alt="23"></p>
<p>然后就是往上找这个 32 位字符串怎么来的，这里就直接贴上我找的日志：</p>
<pre><code class="hljs yaml"><span class="hljs-string">======================================</span> <span class="hljs-string">数组</span> <span class="hljs-number">2</span> <span class="hljs-string">逻辑======================================</span>

<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">880</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[2]</span> <span class="hljs-string">=</span> <span class="hljs-string">Math.random()</span>     <span class="hljs-string">=&gt;</span>  <span class="hljs-number">0.09380310471283848</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">24</span> <span class="hljs-string">索引S</span> <span class="hljs-number">882</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[3]</span> <span class="hljs-string">=</span> [<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span><span class="hljs-string">...&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;z&#x27;</span>]  <span class="hljs-string">=&gt;</span>  <span class="hljs-number">0</span><span class="hljs-number">-9</span><span class="hljs-string">、A-Z、a-z</span> <span class="hljs-string">组成</span> <span class="hljs-number">62</span> <span class="hljs-string">位数组</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">30</span> <span class="hljs-string">索引S</span> <span class="hljs-number">886</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[3]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[3].length</span> <span class="hljs-string">=</span> <span class="hljs-number">62</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">42</span> <span class="hljs-string">索引S</span> <span class="hljs-number">892</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[2]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[3]</span> <span class="hljs-string">*</span> <span class="hljs-string">w[2]</span>       <span class="hljs-string">=&gt;</span>  <span class="hljs-number">62</span> <span class="hljs-string">*</span> <span class="hljs-number">0.09380310471283848</span> <span class="hljs-string">=</span> <span class="hljs-number">5.815792492195985</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">48</span> <span class="hljs-string">索引S</span> <span class="hljs-number">894</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[1]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[1]</span> <span class="hljs-string">|</span> <span class="hljs-string">w[2]</span>       <span class="hljs-string">=&gt;</span>  <span class="hljs-number">0</span> <span class="hljs-string">|</span> <span class="hljs-number">5.815792492195985</span> <span class="hljs-string">=</span> <span class="hljs-number">5</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">31</span> <span class="hljs-string">索引S</span> <span class="hljs-number">896</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">y</span> <span class="hljs-string">=</span> <span class="hljs-string">w[1],</span> <span class="hljs-string">l[10]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[y]</span>   <span class="hljs-string">=&gt;</span>  <span class="hljs-string">l[10]</span> <span class="hljs-string">=</span> <span class="hljs-number">5</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">24</span> <span class="hljs-string">索引S</span> <span class="hljs-number">900</span> <span class="hljs-string">值w:</span> 
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">24</span> <span class="hljs-string">索引S</span> <span class="hljs-number">904</span> <span class="hljs-string">值w:</span> 
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">24</span> <span class="hljs-string">索引S</span> <span class="hljs-number">908</span> <span class="hljs-string">值w:</span> 
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">24</span> <span class="hljs-string">索引S</span> <span class="hljs-number">912</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">y</span> <span class="hljs-string">=</span> <span class="hljs-string">l[10],</span> <span class="hljs-string">w[4]</span> <span class="hljs-string">=</span> <span class="hljs-string">y</span>      <span class="hljs-string">=&gt;</span>  <span class="hljs-string">w[4]</span> <span class="hljs-string">=</span> <span class="hljs-number">5</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">25</span> <span class="hljs-string">索引S</span> <span class="hljs-number">916</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[3]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[3][w[4]]</span>        <span class="hljs-string">=&gt;</span>  <span class="hljs-string">w[3]</span> <span class="hljs-string">=</span> [<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span><span class="hljs-string">...&#x27;y&#x27;</span>,<span class="hljs-string">&#x27;z&#x27;</span>][<span class="hljs-number">5</span>] <span class="hljs-string">=</span> <span class="hljs-string">&#x27;5&#x27;</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">13</span> <span class="hljs-string">索引S</span> <span class="hljs-number">918</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[1][0]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[3]</span>           <span class="hljs-string">=&gt;</span>  <span class="hljs-string">w[1]</span> <span class="hljs-string">=</span> [<span class="hljs-string">&#x27;5&#x27;</span>]


<span class="hljs-string">上述步骤一直重复，w[1][0]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[3]、w[1][1]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[3]、</span> <span class="hljs-string">w[1][2]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[3]</span> <span class="hljs-string">以此类推</span>
<span class="hljs-string">直到</span> <span class="hljs-string">w[1]</span> <span class="hljs-string">累积成一个</span> <span class="hljs-number">32</span> <span class="hljs-string">位数组后：[&quot;5&quot;,&quot;B&quot;,&quot;q&quot;,&quot;j&quot;,&quot;3&quot;,...,&quot;T&quot;,&quot;Z&quot;,&quot;v&quot;,&quot;K&quot;,&quot;j&quot;]</span>


<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">966</span>  <span class="hljs-string">值w:</span>  <span class="hljs-string">g.join(m)</span>  <span class="hljs-string">=&gt;</span>  [<span class="hljs-string">&quot;5&quot;</span>,<span class="hljs-string">&quot;B&quot;</span>,<span class="hljs-string">&quot;q&quot;</span>,<span class="hljs-string">&quot;j&quot;</span>,<span class="hljs-string">&quot;3&quot;</span>,<span class="hljs-string">...</span>,<span class="hljs-string">&quot;T&quot;</span>,<span class="hljs-string">&quot;Z&quot;</span>,<span class="hljs-string">&quot;v&quot;</span>,<span class="hljs-string">&quot;K&quot;</span>,<span class="hljs-string">&quot;j&quot;</span>]<span class="hljs-string">.join(&quot;&quot;)</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">4</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">2524</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">E(m)</span>       <span class="hljs-string">=&gt;</span>  <span class="hljs-string">v(&quot;5Bqj3BmgfWfa7W6AnapzbdqbO0lTZvKj&quot;)</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">29</span> <span class="hljs-string">索引S</span> <span class="hljs-number">2526</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">2</span></code></pre>
<p><strong>归纳一下数组 2 的生成步骤：</strong></p>
<pre><code class="hljs text">Math.random() 方法生成一个随机数；

生成一个由 0-9、A-Z、a-z 组成 62 位数组 [&#x27;0&#x27;,&#x27;1&#x27;,&#x27;2&#x27;...&#x27;y&#x27;,&#x27;z&#x27;]；

取 62 位数组的长度为定值 62；

0 | 62 * 随机数，得到一个整数；

上一步整数当作索引，取 62 位数组里的一个元素，放到一个新数组里；

重复以上步骤，直到取了 32 个元素，即新数组长度为 32；

将新 32 位数组经过 .join(&quot;&quot;) 方法转换为 32 位的字符串；

将 32 位字符串，每一个字符转换成对应的 Unicode 编码，得到数组 2</code></pre>
<p>进一步总结：<strong>实际上这么多骚操作，就是在  62 位数组里随机取值，组成 32 位字符串，再转 Unicode 就行了</strong>，本地复现很简单：</p>
<pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRandomStr</span>(<span class="hljs-params">count</span>) </span>&#123;
    <span class="hljs-keyword">var</span> arr = [<span class="hljs-string">&quot;0&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>,<span class="hljs-string">&quot;3&quot;</span>,<span class="hljs-string">&quot;4&quot;</span>,<span class="hljs-string">&quot;5&quot;</span>,<span class="hljs-string">&quot;6&quot;</span>,<span class="hljs-string">&quot;7&quot;</span>,<span class="hljs-string">&quot;8&quot;</span>,<span class="hljs-string">&quot;9&quot;</span>,<span class="hljs-string">&quot;A&quot;</span>,<span class="hljs-string">&quot;B&quot;</span>,<span class="hljs-string">&quot;C&quot;</span>,<span class="hljs-string">&quot;D&quot;</span>,<span class="hljs-string">&quot;E&quot;</span>,<span class="hljs-string">&quot;F&quot;</span>,<span class="hljs-string">&quot;G&quot;</span>,<span class="hljs-string">&quot;H&quot;</span>,<span class="hljs-string">&quot;I&quot;</span>,<span class="hljs-string">&quot;J&quot;</span>,<span class="hljs-string">&quot;K&quot;</span>,<span class="hljs-string">&quot;L&quot;</span>,<span class="hljs-string">&quot;M&quot;</span>,<span class="hljs-string">&quot;N&quot;</span>,<span class="hljs-string">&quot;O&quot;</span>,<span class="hljs-string">&quot;P&quot;</span>,<span class="hljs-string">&quot;Q&quot;</span>,<span class="hljs-string">&quot;R&quot;</span>,<span class="hljs-string">&quot;S&quot;</span>,<span class="hljs-string">&quot;T&quot;</span>,<span class="hljs-string">&quot;U&quot;</span>,<span class="hljs-string">&quot;V&quot;</span>,<span class="hljs-string">&quot;W&quot;</span>,<span class="hljs-string">&quot;X&quot;</span>,<span class="hljs-string">&quot;Y&quot;</span>,<span class="hljs-string">&quot;Z&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>,<span class="hljs-string">&quot;e&quot;</span>,<span class="hljs-string">&quot;f&quot;</span>,<span class="hljs-string">&quot;g&quot;</span>,<span class="hljs-string">&quot;h&quot;</span>,<span class="hljs-string">&quot;i&quot;</span>,<span class="hljs-string">&quot;j&quot;</span>,<span class="hljs-string">&quot;k&quot;</span>,<span class="hljs-string">&quot;l&quot;</span>,<span class="hljs-string">&quot;m&quot;</span>,<span class="hljs-string">&quot;n&quot;</span>,<span class="hljs-string">&quot;o&quot;</span>,<span class="hljs-string">&quot;p&quot;</span>,<span class="hljs-string">&quot;q&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,<span class="hljs-string">&quot;s&quot;</span>,<span class="hljs-string">&quot;t&quot;</span>,<span class="hljs-string">&quot;u&quot;</span>,<span class="hljs-string">&quot;v&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,<span class="hljs-string">&quot;x&quot;</span>,<span class="hljs-string">&quot;y&quot;</span>,<span class="hljs-string">&quot;z&quot;</span>];
    <span class="hljs-keyword">var</span> i = arr.length, min = i - count, index;
    <span class="hljs-keyword">var</span> str = <span class="hljs-string">&quot;&quot;</span>
    <span class="hljs-keyword">while</span> (i-- &gt; min) &#123;
        index = <span class="hljs-built_in">Math</span>.floor((i + <span class="hljs-number">1</span>) * <span class="hljs-built_in">Math</span>.random());
        str += arr[index]
    &#125;
    <span class="hljs-keyword">return</span> str
&#125;

<span class="hljs-keyword">var</span> randomStr = getRandomStr(<span class="hljs-number">32</span>)
<span class="hljs-keyword">var</span> array2 = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(Buffer.from(randomStr));</code></pre>
<h4><span id="shu-zu-3-shang-qian-wei">数组 3（上千位）</span></h4>
<p>再来看数组 3，也就是有好几千位的这个数组怎么来的。</p>
<p><code>位置 7-2 索引C 31 索引S 614 值w</code>：第一次出现数组 3，到这里就可以看到有 <code>AES</code> 相关字样，稍微往前翻翻还能看到 <code>AES-GCM</code>、<code>iv</code>、<code>key</code> 等字样，这里其实就可以大胆猜测一下了，这个数组 3 的长度很长但不是固定的，肯定是和轨迹之类的有关，会随着轨迹的长短变化而变化，中间还可能用到了 AES 或者 AES-GCM 加密算法。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/24.png" alt="24"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/25.png" alt="25"></p>
<p>这里直接搜索这个数组 3，会发现就只有这一个结果，那么就看上一步，下条件断点看看。</p>
<p><code>位置 7-2 索引C 26 索引S 610 值w</code>：这里的 w[1] 为 <code>Uint8Array()</code> 方法，w[2] 为 <code>ArrayBuffer</code> 对象，<code>new Uint8Array(ArrayBuffer) </code> 就得到数组 3 了。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/26.png" alt="26"></p>
<p>接下来的重点就是找一下 <code>ArrayBuffer</code> 对象怎么来的，这个对象在日志里是搜索不到的（当然也可以改一下日志的写法，判断一下类型，是 <code>ArrayBuffer</code> 对象的话，给它转成 <code>Uint8Array</code> 打印出来，不过太麻烦了没这必要），一般的思路是按照打印的日志，挨个往上找，看看在哪里生成这个 <code>ArrayBuffer</code>，不过这样稍稍有点儿麻烦，下面介绍一个取巧的思路。</p>
<p>观察日志，<code>位置 7-2 索引C 31 索引S 614 值w</code> 这个地方是第一次出现数组 3 的地方，往前几步，<code>位置 7-2 索引C 0 索引S 642 值w</code> 这个地方又有一个大数组，我们称其为<strong>数组 3-A</strong>，如下图所示：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/27.png" alt="27"></p>
<p>大胆猜测 <code>ArrayBuffer</code> 的生成，与数组 3-A 有关，接下来的思路就是从数组 3-A 第一次出现的地方开始，一直单步跟，看能不能生成，以及怎么生成 <code>ArrayBuffer</code> 的。</p>
<p><code>位置 7-2 索引C 10 索引S 568 值w</code>：第一次出现数组 3-A。</p>
<p><code>位置 7-2 索引C 16 索引S 574 值w</code>：这里出现了 <code>SubtleCrypto.encrypt()</code> 方法，查一下文档：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/SubtleCrypto">https://developer.mozilla.org/zh-CN/docs/Web/API/SubtleCrypto</a> ，可以知道这里就是使用了 AES-GCM 加密算法，返回的是一个 <code>Promise</code> 异步对象，而加密的对象正是数组 3-A，如下图所示：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/28.png" alt="28"></p>
<p><code>位置 7-2 索引C 16 索引S 640 值w</code>：走到这里的时候 <code>Promise.then()</code> 将 AES-GCM 加密结果给到 <code>arguments</code>，这里第一次出现了 <code>ArrayBuffer</code>，如下图所示：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/29.png" alt="29"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/30.png" alt="30"></p>
<p>确定了是 AES-GCM 加密，我们本地应该怎样实现呢？这里给出 JS 和 Python 版本的实现方法（PS：不知道怎么实现建议直接问 ChatGPT）：</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">const</span> Crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">aesEncrypt</span>(<span class="hljs-params">text, key, iv</span>) </span>&#123;
    <span class="hljs-comment">// 创建加密器</span>
    <span class="hljs-keyword">const</span> cipher = Crypto.createCipheriv(<span class="hljs-string">&#x27;aes-256-gcm&#x27;</span>, key, iv);
    <span class="hljs-comment">// 加密明文</span>
    <span class="hljs-keyword">const</span> ciphertextPart1 = cipher.update(text, <span class="hljs-string">&#x27;utf8&#x27;</span>);
    <span class="hljs-keyword">const</span> ciphertextPart2 = cipher.final();
    <span class="hljs-comment">// 获取 GCM 校验值</span>
    <span class="hljs-keyword">const</span> tag = cipher.getAuthTag();
    <span class="hljs-comment">// 将加密结果和 GCM 校验值拼接</span>
    <span class="hljs-keyword">const</span> ciphertext = Buffer.concat([ciphertextPart1, ciphertextPart2, tag]);
    <span class="hljs-keyword">return</span> ciphertext;
&#125;

<span class="hljs-keyword">const</span> key = Buffer.from(<span class="hljs-string">&#x27;adaae7a5ef9f301a445888beb9205be2f83660246b8153d8a677794e0d2af7de&#x27;</span>, <span class="hljs-string">&#x27;hex&#x27;</span>)
<span class="hljs-keyword">const</span> iv = Buffer.from(<span class="hljs-string">&#x27;b963490c4e5b50bce2c77d06&#x27;</span>, <span class="hljs-string">&#x27;hex&#x27;</span>)
<span class="hljs-keyword">const</span> plaintext = <span class="hljs-string">&#x27;This is a secret message.&#x27;</span>;
<span class="hljs-keyword">const</span> encryptedData = aesEncrypt(plaintext, key, iv)

<span class="hljs-built_in">console</span>.log(encryptedData)
<span class="hljs-built_in">console</span>.log(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(encryptedData))
<span class="hljs-built_in">console</span>.log(encryptedData.toString(<span class="hljs-string">&#x27;hex&#x27;</span>))</code></pre>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> hexlify
<span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES


key = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&#x27;adaae7a5ef9f301a445888beb9205be2f83660246b8153d8a677794e0d2af7de&#x27;</span>)
nonce = <span class="hljs-built_in">bytes</span>.fromhex(<span class="hljs-string">&#x27;b963490c4e5b50bce2c77d06&#x27;</span>)
plaintext = <span class="hljs-string">b&#x27;This is a secret message.&#x27;</span>
crypto = AES.new(key=key, mode=AES.MODE_GCM, nonce=nonce)
ciphertext, tag = crypto.encrypt_and_digest(plaintext)
encrypted_data = hexlify(ciphertext + tag).decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)
<span class="hljs-built_in">print</span>(encrypted_data)</code></pre>
<p>走到这儿了，我们还需要搞定三个东西：AES-GCM 的 key 和 iv，以及被加密对象数组 3-A 是怎么来的。套路都是一样的，这里我也直接贴上我的分析笔记了：</p>
<pre><code class="hljs yaml"><span class="hljs-string">======================================</span> <span class="hljs-string">数组</span> <span class="hljs-number">3</span> <span class="hljs-string">逻辑======================================</span>

<span class="hljs-string">//</span> <span class="hljs-string">AES-GCM</span> <span class="hljs-string">key、iv</span> <span class="hljs-string">逻辑</span>
           
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">2</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">184</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">String.fromCharCode</span> <span class="hljs-string">生成</span> <span class="hljs-number">128</span> <span class="hljs-string">位字符串</span> <span class="hljs-string">s4,</span> <span class="hljs-string">为固定值</span>  <span class="hljs-string">=&gt;</span>  <span class="hljs-string">4dd4c2e6b83...38aadd58</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">31</span> <span class="hljs-string">索引S</span> <span class="hljs-number">190</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现固定</span> <span class="hljs-number">128</span> <span class="hljs-string">位字符串</span> <span class="hljs-string">s4</span>


<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">4</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">206</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">SHA512(前面数组</span> <span class="hljs-number">2</span> <span class="hljs-string">里的随机字符串)</span>  <span class="hljs-string">=&gt;</span>  <span class="hljs-string">SHA512(&quot;5Bqj3BmgfWfa7W6AnapzbdqbO0lTZvKj&quot;)</span> <span class="hljs-string">生成数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D3</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">34</span> <span class="hljs-string">索引S</span> <span class="hljs-number">208</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D3</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">232</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D3.toString()</span> <span class="hljs-string">生成字符串</span> <span class="hljs-string">s3</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">31</span> <span class="hljs-string">索引S</span> <span class="hljs-number">234</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现字符串</span> <span class="hljs-string">s3</span>


<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">40</span> <span class="hljs-string">索引S</span> <span class="hljs-number">246</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">字符串</span> <span class="hljs-string">s3</span> <span class="hljs-string">+</span> <span class="hljs-string">字符串</span> <span class="hljs-string">s4</span> <span class="hljs-string">得到长字符串</span> <span class="hljs-string">s2</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">280</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">CryptoJS.enc.Hex.parse(长字符串</span> <span class="hljs-string">s2)</span> <span class="hljs-string">得到数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D2</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">31</span> <span class="hljs-string">索引S</span> <span class="hljs-number">282</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D2</span>


<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">4</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">298</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">SHA512(数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D2)</span> <span class="hljs-string">得到数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D1</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">34</span> <span class="hljs-string">索引S</span> <span class="hljs-number">300</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D1</span>


<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">324</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">数组</span> <span class="hljs-number">3</span><span class="hljs-string">-D1.toString()</span> <span class="hljs-string">生成长字符串</span> <span class="hljs-string">s1</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">31</span> <span class="hljs-string">索引S</span> <span class="hljs-number">326</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现长字符串</span> <span class="hljs-string">s1</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">450</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">key</span> <span class="hljs-string">=</span> <span class="hljs-string">长字符串</span> <span class="hljs-string">s1.substring(0,</span> <span class="hljs-number">64</span><span class="hljs-string">)</span>
<span class="hljs-string">位置</span> <span class="hljs-number">6</span><span class="hljs-number">-1</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">484</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">iv</span> <span class="hljs-string">=</span> <span class="hljs-string">长字符串</span> <span class="hljs-string">s1.substring(64,</span> <span class="hljs-number">88</span><span class="hljs-string">)</span>


<span class="hljs-string">//</span> <span class="hljs-string">数组</span> <span class="hljs-number">3</span> <span class="hljs-string">逻辑</span>

<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1838</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">CryptoJS.enc.Utf8.parse(unescape(encodeURIComponent(JSON.stringify(轨迹))))</span> <span class="hljs-string">得到数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C2</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">29</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1840</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C2</span>


<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">4</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">1866</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">SHA512(JSON.stringify(轨迹))</span> <span class="hljs-string">得到数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C1-1</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">34</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1868</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C1-1</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1892</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C1-1.toString()</span> <span class="hljs-string">生成一个字符串</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">29</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1894</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现字符串</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1936</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">CryptoJS.enc.Hex.parse</span> <span class="hljs-string">方法将字符串处理成数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C1</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">29</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1938</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C1</span>


<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">1998</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">concat</span> <span class="hljs-string">方法拼接数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C1</span> <span class="hljs-string">和数组</span> <span class="hljs-number">3</span><span class="hljs-string">-C2</span> <span class="hljs-string">得到数组</span> <span class="hljs-number">3</span><span class="hljs-string">-B</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">29</span> <span class="hljs-string">索引S</span> <span class="hljs-number">2000</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-B</span>


<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">564</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">数组</span> <span class="hljs-number">3</span><span class="hljs-string">-B</span> <span class="hljs-string">.toString()</span> <span class="hljs-string">生成一个大字符串</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">4</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">566</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">大字符串经过</span> <span class="hljs-string">g()</span> <span class="hljs-string">方法生成数组</span> <span class="hljs-number">3</span><span class="hljs-string">-A</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">10</span> <span class="hljs-string">索引S</span> <span class="hljs-number">568</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-A</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">574</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">SubtleCrypto.encrypt()</span> <span class="hljs-string">=&gt;</span> <span class="hljs-string">AES-GCM</span> <span class="hljs-string">加密数组</span> <span class="hljs-number">3</span><span class="hljs-string">-A,</span> <span class="hljs-string">返回</span> <span class="hljs-string">Promise</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">34</span> <span class="hljs-string">索引S</span> <span class="hljs-number">576</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[2]</span> <span class="hljs-string">=</span> <span class="hljs-string">Promise</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">30</span> <span class="hljs-string">索引S</span> <span class="hljs-number">578</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[2]</span> <span class="hljs-string">=</span> <span class="hljs-string">Promise.then()</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">36</span> <span class="hljs-string">索引S</span> <span class="hljs-number">584</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">y</span> <span class="hljs-string">=</span> <span class="hljs-string">w[2],</span> <span class="hljs-string">w[2]</span> <span class="hljs-string">=</span> <span class="hljs-string">w[1],</span> <span class="hljs-string">w[1]</span> <span class="hljs-string">=</span> <span class="hljs-string">y</span>  <span class="hljs-string">=&gt;</span> <span class="hljs-string">w[1]</span> <span class="hljs-string">=</span> <span class="hljs-string">Promise.then(),</span> <span class="hljs-string">w[2]</span> <span class="hljs-string">=</span> <span class="hljs-string">Promise</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">2</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">586</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[3]</span> <span class="hljs-string">=</span> <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">37</span> <span class="hljs-string">索引S</span> <span class="hljs-number">592</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[3]</span> <span class="hljs-string">=</span> <span class="hljs-string">t()</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">10</span> <span class="hljs-string">索引S</span> <span class="hljs-number">634</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">w[3]</span> <span class="hljs-string">=</span> [<span class="hljs-string">t()</span>]
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">16</span> <span class="hljs-string">索引S</span> <span class="hljs-number">640</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">执行</span> <span class="hljs-string">Promise.then(),</span> <span class="hljs-string">加密结果赋值给</span> <span class="hljs-string">t()</span> <span class="hljs-string">里的</span> <span class="hljs-string">arguments,</span> <span class="hljs-string">第一次出现</span> <span class="hljs-string">ArrayBuffer</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">0</span>  <span class="hljs-string">索引S</span> <span class="hljs-number">642</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">最后一次出现数组</span> <span class="hljs-number">3</span><span class="hljs-string">-A</span>


<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">27</span> <span class="hljs-string">索引S</span> <span class="hljs-number">598</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">没啥用</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">11</span> <span class="hljs-string">索引S</span> <span class="hljs-number">602</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">没啥用</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">24</span> <span class="hljs-string">索引S</span> <span class="hljs-number">606</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">没啥用</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">26</span> <span class="hljs-string">索引S</span> <span class="hljs-number">610</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">new</span> <span class="hljs-string">w[1](w[2])</span> <span class="hljs-string">=&gt;</span> <span class="hljs-string">new</span> <span class="hljs-string">Uint8Array(ArrayBuffer)</span>
<span class="hljs-string">位置</span> <span class="hljs-number">7</span><span class="hljs-number">-2</span> <span class="hljs-string">索引C</span> <span class="hljs-number">31</span> <span class="hljs-string">索引S</span> <span class="hljs-number">614</span> <span class="hljs-string">值w:</span>  <span class="hljs-string">第一次出现数组</span> <span class="hljs-number">3</span></code></pre>
<p>以上日志中涉及到的部分方法：</p>
<pre><code class="hljs javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">u</span>(<span class="hljs-params">e</span>) </span>&#123;
  <span class="hljs-keyword">var</span> t = e.map;
  <span class="hljs-keyword">return</span> e === <span class="hljs-built_in">Array</span>.prototype || e <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span> &amp;&amp; t === <span class="hljs-built_in">Array</span>.prototype.map ? t : t
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">g</span>(<span class="hljs-params">e</span>) </span>&#123;
  <span class="hljs-keyword">var</span> t;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(u(t = e.match(<span class="hljs-regexp">/[\da-f]&#123;2&#125;/gi</span>)).call(t, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>&#123;
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(e, <span class="hljs-number">16</span>)
  &#125;))
&#125;</code></pre>
<p><strong>总结一下数组 3 的生成步骤：</strong></p>
<pre><code class="hljs text">固定字符串 4dd4c2e6b83...38aadd58 + SHA512(数组 2 里的随机字符串) 组成一个长字符串 s2；

SHA512(CryptoJS.enc.Hex.parse(长字符串 s2)).toString() 得到长字符串 s1；

AES-GCM key 的值为：长字符串 s1.substring(0, 64)；

AES-GCM iv 的值为：长字符串 s1.substring(64, 88)；

CryptoJS.enc.Utf8.parse(unescape(encodeURIComponent(JSON.stringify(轨迹)))) 得到数组 3-C2；

CryptoJS.enc.Hex.parse(SHA512(JSON.stringify(轨迹)).toString()) 得到 数组 3-C1；

数组 3-C1.concat(数组 3-C2)得到数组 3-B；

g(数组 3-B.toString()) 得到数组 3-A；

new Uint8Array(AES-GCM 加密数组 3-A) 得到数组 3。</code></pre>
<p>至此，captchaBody 的逻辑就找完了，还是比较简单的，现在就缺一个轨迹参数了。</p>
<h3><span id="gui-ji-sheng-cheng">轨迹生成</span></h3>
<p>根据我们前面的分析日志可知，数组 3 的生成逻辑中，<code>位置 7-2 索引C 16 索引S 1838 值w</code> 和 <code>位置 7-2 索引C 4  索引S 1866 值w</code> 这两个地方对轨迹进行了加密，先将轨迹 copy 下来看看结构。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/31.png" alt="31"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/32.png" alt="32"></p>
<p><code>modified_img_width</code>、<code>detRes</code> 为定值，<code>id</code> 为 <code>captcha/get</code> 接口返回的，然后主要就是 <code>reply</code> 和 <code>reply2</code>、<code>models</code> 和 <code>models2</code> 以及 <code>log_params</code>。</p>
<p>轨迹里主要有两个记录点：</p>
<p><code>位置 4-1 索引j 0 索引C 2584 值x</code>：记录鼠标在验证码区域移动的轨迹，该轨迹为 <code>models[&quot;z&quot;]</code> 的值。</p>
<p><code>位置 4-1 索引j 0 索引C 1776 值x</code>：记录鼠标滑动滑块的轨迹，该轨迹为 <code>reply</code> 的值，根据缺口距离伪造就行了。</p>
<p><img src="https://cdn.itbob.cn/img/article/070/33.png" alt="33"></p>
<p><img src="https://cdn.itbob.cn/img/article/070/34.png" alt="34"></p>
<p><code>位置 4-1 索引j 29 索引C 2134 值x</code>：第一次出现 <code>models[&quot;x&quot;]</code>，大致为鼠标第一次进入验证码弹框区域的坐标。</p>
<p><code>位置 4-1 索引j 29 索引C 2098 值x</code>：第一次出现 <code>models[&quot;y&quot;]</code>，大致为鼠标最后一次进入验证码滑条区域的坐标。</p>
<p>而 <code>models[&quot;m&quot;]</code> 则可以在 <code>models[&quot;z&quot;]</code> 的基础上随机增减一些值即可，至此 <code>reply</code> 和 <code>models</code> 就处理完了，还有对应的 <code>reply2</code> 和 <code>models2</code>，都是在 <code>reply</code> 和 <code>models</code> 的基础上进行取值，自己找一下规律就可以了，也可以观察日志找一下怎么取值的，而 <code>log_params</code> 里，会有一些 <code>challenge_code</code> 等参数，都可以在之前的接口返回参数里找到值，<code>log_params</code> 里也有 <code>models</code> 和 <code>models2</code>，区别就在于 <code>log_params</code> 里的没有 <code>models[&quot;m&quot;]</code> 和 <code>models2[&quot;m&quot;]</code>，其他值都一样。</p>
<p>至此所有参数就都搞定了，<strong>还有一个细节需要注意一下，那就是提交验证太快了也不行，在请求 <code>captcha/verify</code> 接口之前睡眠两三秒就行了！</strong></p>
<h2><span id="jie-guo-yan-zheng">结果验证</span></h2>
<p>测试通过率在 98% 左右：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/35.png" alt="35"></p>
<p>测试将通过验证码的 <code>fp</code> 值作为 cookie 的 <code>s_v_web_id</code>，可以免 <code>X-Bogus</code> 验证采集数据，以下是采集评论示例：</p>
<p><img src="https://cdn.itbob.cn/img/article/070/36.png" alt="36"></p>

            </div>
        </article>
    </div>
    <br>
    
        <div class="next-prev-post">
            
            
                <div class="next-post">
                    <div class="next gt-c-content-color-first">
                        下一篇：<a href="/article/069/" 
                            class="post-title gt-a-link">数美验证全家桶逆向分析以及 AST 获取动态参数</a>
                    </div>
                </div>
            
        </div>
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>

    <div id="gitalk-container"></div>

    <script>
    var gitalk = new Gitalk({
        clientID: 'd19a84b9d9a2ddb2c6b9',
        clientSecret: 'cec9feae5129a6106edc68ce06d167be8eb06021',
        repo: 'trhx.github.io',
        owner: 'TRHX',
        admin: ['TRHX'],
        id: md5(location.pathname),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false       // Facebook-like distraction free mode
    });
    gitalk.render('gitalk-container');
    </script>


    
</div>

                <div class="site-footer gt-c-content-color-first">
    <div class="footer-main">
        <!-- 建议保留版权信息或者添加主题信息到友链，感谢您的理解 -->
        <!-- 文件位置：layout/_includes/footer.ejs -->
        <!-- <span style="text-align: right; float: right;">
            Theme 
            <a href="https://github.com/renbaoshuo/hexo-theme-pure" target="_blank">Pure</a>
             | Powered by
            <a href="https://hexo.io" target="_blank">Hexo</a>
        </span>
        <span style="text-align: left;"></span> -->
        <span>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fas fa-user"></i> UV
                </span>
                <span class="badge-value bg-pink" id="busuanzi_value_site_uv"></span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fas fa-user-plus"></i> PV
                </span>
                <span class="badge-value bg-blue" id="busuanzi_value_site_pv"></span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fa fa-keyboard"></i> Word Count
                </span>
                <span class="badge-value bg-firebrick post-count">319.8k</span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fa fa-cog fa-spin"></i> Powered by
                </span>
                <span class="badge-value bg-brightgreen"><a href="https://hexo.io" target="_blank">Hexo</a></span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fa fa-paper-plane"></i> Theme
                </span>
                <span class="badge-value bg-orange"><a href="https://github.com/renbaoshuo/hexo-theme-pure" target="_blank">Pure</a></span>
            </div>
        </span>
        <br/>
        <br/>

        <span style="text-align: center; float: center;">
            Copyright <i class="fa fa-copyright"></i> 2018 - <script>document.write(new Date().getFullYear());</script> <a href="https://www.itbob.cn/" target="_blank">ITBOB.CN</a> 丨
            <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">
                <i class="fab fa-creative-commons"></i>
                <i class="fab fa-creative-commons-by"></i>
                <i class="fab fa-creative-commons-nc"></i>
                <i class="fab fa-creative-commons-nd"></i>
            </a> 丨
            <!-- <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a> 丨 -->
            <span id="sitetime">正在载入网站运行时间...</span>
            <script>
                function siteTime(){
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth()+1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    /* 
                    Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
                    year - 作为date对象的年份，为4位年份值
                    month - 0-11之间的整数，做为date对象的月份
                    day - 1-31之间的整数，做为date对象的天数
                    hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
                    minutes - 0-59之间的整数，做为date对象的分钟数
                    seconds - 0-59之间的整数，做为date对象的秒数
                    microseconds - 0-999之间的整数，做为date对象的毫秒数
                    */
                    var t1 = Date.UTC(2018,08,10,17,38,00); //北京时间2018-8-10 17:38:00
                    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
                    var diff = t2-t1;
                    var diffYears = Math.floor(diff/years);
                    var diffDays = Math.floor((diff/days)-diffYears*365);
                    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
                    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
                    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
                    document.getElementById("sitetime").innerHTML="小破站已运行了 "
                    + "<font style='color:#FE3C65;font-weight:bold'>" + diffYears + "</font>" + " 年 "
                    + "<font style='color:#FFA500;font-weight:bold'>" + diffDays + "</font>" + " 天 "
                    + "<font style='color:#1DBF97;font-weight:bold'>" + diffHours + "</font>" + " 小时 "
                    + "<font style='color:#8A2BE2;font-weight:bold'>" + diffMinutes + "</font>" + " 分 "
                    + "<font style='color:#007EC6;font-weight:bold'>" + diffSeconds + "</font>" + " 秒 ";
                }
                siteTime();
            </script>
        </span>
        <br/>
        <br/>
        <span>
            <img src="https://cdn.itbob.cn/img/footer/icp.png" class="nofancybox" alt="ICP" style="width:auto; height:20px; margin-bottom:-4px"><a href="https://beian.miit.gov.cn/" target="_blank"> 鄂ICP备19003281号-7</a>丨
            <img src="https://cdn.itbob.cn/img/footer/moeicp.png" class="nofancybox" alt="MOE ICP" style="width:auto; height:18px; margin-bottom:-3.5px"><a href="https://icp.gov.moe/" target="_blank"> 萌ICP备20202022号</a>丨
            <img src="https://cdn.itbob.cn/img/footer/webify.png" class="nofancybox" alt="腾讯云开发 Webify" style="width:auto; height:25px; margin-bottom:-8px"><a href="https://webify.cloudbase.net/" target="_blank"> 云开发 Webify</a>丨
            <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="https://cdn.itbob.cn/img/footer/upyun.png" class="nofancybox" alt="又拍云赞助云存储" style="width:auto; height:19px; margin-bottom:-4px"></a> 赞助CDN/COS服务丨
            <a href="https://www.foreverblog.cn/" target="_blank"><img src="https://cdn.itbob.cn/img/footer/foreverblog.png" class="nofancybox" alt="十年之约" style="width:auto; height:15px; margin-bottom:-2px"></a>
        </span>
    </div>
</div>

<!-- <div class="sidebar_wo" id="leimu">
    <img src="https://cdn.itbob.cn/img/footer/leimuA.png" class="nofancybox" alt="雷姆" 
    onmouseover="this.src='https://cdn.itbob.cn/img/footer/leimuB.png'" 
    onmouseout="this.src='https://cdn.itbob.cn/img/footer/leimuA.png'" title="回到底部">
</div>
<div class="sidebar_wo" id="lamu">
    <img src="https://cdn.itbob.cn/img/footer/lamuA.png" class="nofancybox" alt="雷姆" 
    onmouseover="this.src='https://cdn.itbob.cn/img/footer/lamuB.png'" 
    onmouseout="this.src='https://cdn.itbob.cn/img/footer/lamuA.png'" title="回到顶部">
</div> -->

<script>
    /* 拉姆蕾姆回到顶部或底部按钮 */
    $(function() {
        $("#leimu img").eq(0).click(function() {
            $("html,body").animate({scrollTop:$(document).height()},800);
            return false;
        });
        $("#lamu img").eq(0).click(function() {
            $("html,body").animate({scrollTop:0},800);
            return false;
        });
    });
</script>

            </div>
        </div>
        <!-- <a id="back-to-top" class="back-to-top show hl fa fa-arrow-up" href="javascript:void(0)" title="回到顶部"></a> -->
        <a id="back-to-top" class="back-to-top2" href="javascript:void(0)" title="回到顶部">
            <img class="nofancybox" src="https://cdn.itbob.cn/img/back_to_top.png"/>
        </a>
        <script>
            (function () {
                // When to show the scroll link
                // higher number = scroll link appears further down the page   
                var upperLimit = 100;
                
                // Our scroll link element
                var scrollElem = $('#back-to-top');
            
                // Scroll to top speed
                var scrollSpeed = 500;
            
                // Show and hide the scroll to top link based on scroll position   
                scrollElem.hide();
                $(window).scroll(function () {            
                    var scrollTop = $(document).scrollTop();       
                    if ( scrollTop > upperLimit ) {
                        $(scrollElem).stop().fadeTo(200, 1); // fade back in           
                    }else{       
                        $(scrollElem).stop().fadeTo(200, 0); // fade out
                    }
                });

                // Scroll to top animation on click
                $(scrollElem).click(function(){
                    $('html, body').animate({scrollTop:0}, scrollSpeed); return false;
                });
            })();
        </script>
    </body>
</html>