<!-- 
          _____                   _______                   _____          
          /\    \                 /::\    \                 /\    \         
         /::\    \               /::::\    \               /::\    \        
        /::::\    \             /::::::\    \             /::::\    \       
       /::::::\    \           /::::::::\    \           /::::::\    \      
      /:::/\:::\    \         /:::/~~\:::\    \         /:::/\:::\    \     
     /:::/__\:::\    \       /:::/    \:::\    \       /:::/__\:::\    \    
    /::::\   \:::\    \     /:::/    / \:::\    \     /::::\   \:::\    \   
   /::::::\   \:::\    \   /:::/____/   \:::\____\   /::::::\   \:::\    \  
  /:::/\:::\   \:::\ ___\ |:::|    |     |:::|    | /:::/\:::\   \:::\ ___\ 
 /:::/__\:::\   \:::|    ||:::|____|     |:::|    |/:::/__\:::\   \:::|    |
 \:::\   \:::\  /:::|____| \:::\    \   /:::/    / \:::\   \:::\  /:::|____|
  \:::\   \:::\/:::/    /   \:::\    \ /:::/    /   \:::\   \:::\/:::/    / 
   \:::\   \::::::/    /     \:::\    /:::/    /     \:::\   \::::::/    /  
    \:::\   \::::/    /       \:::\__/:::/    /       \:::\   \::::/    /   
     \:::\  /:::/    /         \::::::::/    /         \:::\  /:::/    /    
      \:::\/:::/    /           \::::::/    /           \:::\/:::/    /     
       \::::::/    /             \::::/    /             \::::::/    /      
        \::::/    /               \::/____/               \::::/    /       
         \::/____/                 ~~                      \::/____/        
          ~~                                                ~~              
                                                                            
                                WWW.ITBOB.CN
                                
                        有毛的叫程序猿，沒毛的叫程序员。
-->

<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Force https -->

    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">


<!-- Title -->
<title>某空气质量监测平台无限 debugger 以及数据动态加密分析 - BOB&#39;S BLOG</title>

<!-- Icon -->
<link rel="icon" href="/img/favicon.ico">

<!-- Fonts -->
<link rel="preload" href="//fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" as="style" onload="this.onload=null, this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="//fonts.googleapis.com/css2?family=Roboto+Mono:ital@0;1&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript>

<!-- Font Awesome -->
<!-- https://fontawesome.dashgame.com/ -->
<!-- <link rel="stylesheet" href="https://cdn.itbob.cn/css/font-awesome@5.6.3/all.min.css"> -->
<link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/5.15.4/css/all.min.css">
<!-- <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.6.3/css/all.min.css"> -->


    <!-- KaTeX -->
    <!-- //cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css -->
    <link rel="preload" href="//cdn.itbob.cn/css/katex@0.12.0/katex.min.css" as="style" onload="this.onload=null, this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="//cdn.itbob.cn/css/katex@0.12.0/katex.min.css"></noscript>


<!-- Style -->

<link rel="stylesheet" href="/styles/main.css">

<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-theme-pure@1.0.1/dist/main.css"> -->

<!-- Analytics -->

    
    
        <!-- Baidu Analytics -->
        <script defer>
            var _hmt = _hmt || [];
            (function () {
                var hm = document.createElement('script');
                hm.src = 'https://hm.baidu.com/hm.js?6ca34ddce088f8434f3c7509576819f2';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
    


<!-- Busuanzi -->
<!-- <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->
<script async src="//cdn.itbob.cn/js/busuanzi@2.3/busuanzi.pure.mini.js"></script>

<!-- Typeit -->
<!-- https://www.typeitjs.com/ -->
<script src="//unpkg.com/typeit@8.7.0/dist/index.umd.js"></script>

<!-- Fancybox -->

    <link rel="stylesheet" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css">
    <script src="//cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js"> </script>
    <script src="//cdn.itbob.cn/js/fancybox@3.5.7/fancybox.js"> </script>

<!-- <script>
  $('[data-fancybox="images"]').fancybox({//可选
    thumbs : {
      autoStart : true //缩略图
    }
  });
  $('[data-fancybox]').fancybox({//启用函数，必须
    protect: true //图片右键不能下载，可选
  });
</script> -->

<!-- Console -->
<script>
    function makeMulti (string) {
        let l = new String(string)
        l = l.substring(l.indexOf("/*") + 3, l.lastIndexOf("*/"))
        return l
    }
    let string = function () {
      /* 
          _____                   _______                   _____          
          /\    \                 /::\    \                 /\    \         
         /::\    \               /::::\    \               /::\    \        
        /::::\    \             /::::::\    \             /::::\    \       
       /::::::\    \           /::::::::\    \           /::::::\    \      
      /:::/\:::\    \         /:::/~~\:::\    \         /:::/\:::\    \     
     /:::/__\:::\    \       /:::/    \:::\    \       /:::/__\:::\    \    
    /::::\   \:::\    \     /:::/    / \:::\    \     /::::\   \:::\    \   
   /::::::\   \:::\    \   /:::/____/   \:::\____\   /::::::\   \:::\    \  
  /:::/\:::\   \:::\ ___\ |:::|    |     |:::|    | /:::/\:::\   \:::\ ___\ 
 /:::/__\:::\   \:::|    ||:::|____|     |:::|    |/:::/__\:::\   \:::|    |
 \:::\   \:::\  /:::|____| \:::\    \   /:::/    / \:::\   \:::\  /:::|____|
  \:::\   \:::\/:::/    /   \:::\    \ /:::/    /   \:::\   \:::\/:::/    / 
   \:::\   \::::::/    /     \:::\    /:::/    /     \:::\   \::::::/    /  
    \:::\   \::::/    /       \:::\__/:::/    /       \:::\   \::::/    /   
     \:::\  /:::/    /         \::::::::/    /         \:::\  /:::/    /    
      \:::\/:::/    /           \::::::/    /           \:::\/:::/    /     
       \::::::/    /             \::::/    /             \::::::/    /      
        \::::/    /               \::/____/               \::::/    /       
         \::/____/                 ~~                      \::/____/        
          ~~                                                ~~              
                                                                            
                                WWW.ITBOB.CN
                                
                        有毛的叫程序猿，沒毛的叫程序员。
      */
    }
    console.log(makeMulti(string));
    console.log("\n %c © ITBOB'S BLOG %c https://www.itbob.cn %c © ITRHX'S BLOG %c https://www.itrhx.com \n", "color: #fadfa3; background: #030307; padding:5px 0;", "background: #fadfa3; padding:5px 0;", "color: #fadfa3; background: #030307; padding:5px 0;", "background: #fadfa3; padding:5px 0;")
</script>

    <meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="BOB'S BLOG" type="application/atom+xml">
</head>
    <body>
        <div class="main gt-bg-theme-color-first">
            <div class="main-content">
                <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/img/avatar.png" alt="头像">
        <div class="site-name gt-c-content-color-first" id="typeitspan">
            <!-- BOB&#39;S BLOG -->
        </div>
    </a>
    <!-- <span id="typeitspan"></span> -->
    <script>
        new TypeIt('#typeitspan', {
        strings: "BOB'S BLOG",
        speed: 150, 
        afterComplete: function (instance) {
            instance.destroy();
        }
        }).go();
    </script>
    <button aria-label="Navbar Toggler" class="navbar-toggler" type="button" id="changeNavbar">
        <i class="gt-c-content-color-first" style="font-size: 18px;">
            <svg xmlns="https://www.w3.org/2000/svg" viewBox="0 0 448 512" height="18px" fill="currentColor">
                <path d="M16 132h416c8.837 0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163 0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837 0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837 0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z" />
            </svg>
        </i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center; ">
            
                
                    <div class="nav-item">
                        <a href="/" class="menu gt-a-link" target="_self">首页</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/archives/" class="menu gt-a-link" target="_self">归档</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/tags/" class="menu gt-a-link" target="_self">标签</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/friends/" class="menu gt-a-link" target="_self">友链</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="/about/" class="menu gt-a-link" target="_self">关于</a>
                    </div>
                
            
                
                    <div class="nav-item">
                        <a href="https://travellings.link" target="_blank">
                            <img src="https://cdn.itbob.cn/img/travelling.gif" class="nofancybox" alt="开往-友链接力" width="auto" height="25px">
                        </a>
                    </div>
                
            
        </div>
    </div>
</nav>

<script>
    /* 移动端导航栏展开/收起切换 */
    document.getElementById('changeNavbar').onclick = function() {
        let element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else { 
            element.style.display = 'none';
        }
    }
</script>

                <div class="post-container">
    <div class="post-detail gt-bg-theme-color-second gt-c-content-color-first">
        <article class="gt-post-content">
            <h1 class="post-title">某空气质量监测平台无限 debugger 以及数据动态加密分析</h1>
            <div class="post-info">
                <time class="post-time gt-c-content-color-first">
                    <i class="fa fa-calendar-alt"></i> 首发于: 2022-01-10丨
                </time>
                <span id="busuanzi_container_page_pv">
                    <i class="fas fa-eye"></i> 阅读量: <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>丨
                </span>
                
                    <span class="post-count">
                        <i class="fa fa-keyboard"></i> 字数统计: 3.8k丨
                    </span>
                    <span class="post-count">
                        <i class="fa fa-hourglass-half"></i> 阅读时长: 15分丨
                    </span>
                
                
                    
                        <!-- <i class="fa fa-tag"></i> -->
                        <i class="fas fa-hashtag"></i>
                        <a href="/tags/%E7%88%AC%E8%99%AB/" class="post-tag">
                            爬虫</a>
                    
                        <!-- <i class="fa fa-tag"></i> -->
                        <i class="fas fa-hashtag"></i>
                        <a href="/tags/JS-%E9%80%86%E5%90%91%E5%AE%9E%E6%88%98/" class="post-tag">
                            JS 逆向实战</a>
                    
                
            </div>
            <hr>
            <div class="post-content gt-c-content-color-first">
                <p><img src="https://cdn.itbob.cn/img/cover/javascript_reverse.png" alt="javascript_reverse"></p>
<center><font color="red" size="5px" weight="bolder">欢迎加入爬虫逆向微信交流群：添加微信 IT-BOB（备注交流群）</font></center>
<h2><span id="wen-zhang-mu-lu">文章目录</span></h2>
<hr>
<!-- toc -->
<ul>
<li><a href="#sheng-ming">声明</a></li>
<li><a href="#ni-xiang-mu-biao">逆向目标</a></li>
<li><a href="#xie-zai-qian-mian">写在前面</a></li>
<li><a href="#rao-guo-wu-xian-debugger">绕过无限 debugger</a>
<ul>
<li><a href="#fang-fa-yi">方法一</a></li>
<li><a href="#fang-fa-er">方法二</a></li>
<li><a href="#fang-fa-san">方法三</a></li>
</ul>
</li>
<li><a href="#zhua-bao-fen-xi">抓包分析</a></li>
<li><a href="#jia-mi-ru-kou">加密入口</a></li>
<li><a href="#dong-tai-js">动态 JS</a></li>
<li><a href="#ben-di-gai-xie">本地改写</a></li>
</ul>
<!-- tocstop -->
<hr>
<h2><span id="sheng-ming">声明</span></h2>
<p><strong><font color="red">本文章中所有内容仅供学习交流使用，不用于其他任何目的，不提供完整代码，抓包内容、敏感网址、数据接口等均已做脱敏处理，严禁用于商业用途和非法用途，否则由此产生的一切后果均与作者无关！</font></strong></p>
<p><strong><font color="red">本文章未经许可禁止转载，禁止任何修改后二次传播，擅自使用本文讲解的技术而导致的任何意外，作者均不负责，若有侵权，请通过邮件 <a href="mailto:admin@itbob.cn">admin@itbob.cn</a> 联系我立即删除！</font></strong></p>
<h2><span id="ni-xiang-mu-biao">逆向目标</span></h2>
<ul>
<li>目标：某空气质量监测平台无限 debugger 以及请求数据、返回数据动态加密、解密</li>
<li>主页：<code>aHR0cHM6Ly93d3cuYXFpc3R1ZHkuY24v</code></li>
<li>接口：<code>aHR0cHM6Ly93d3cuYXFpc3R1ZHkuY24vYXBpbmV3L2FxaXN0dWR5YXBpLnBocA==</code></li>
</ul>
<h2><span id="xie-zai-qian-mian">写在前面</span></h2>
<p>这个站点更新频率很高，在我之前也已经有很多博主写了该站点的分析文章，近期有读者问请求数据的加密和返回数据的解密，发现其加解密 JS 变成了动态的，以前的那些文章提到的解决思路不太行了，但整体上来说也不是很难，只不过处理起来比较麻烦一点，还有一些小细节需要注意。</p>
<p>在网站的“关于系统”里可以看到，这个站貌似是个人开发者在维护，最早在2013年就有了，在友情赞助列表里，可以看到大多数都是一些环境、测绘、公共卫生相关的大学专业、研究院人员，可以猜测到这些数据对于他们的研究是非常有帮助的，再加上反爬更新频繁，可以看出站长饱受爬虫之苦，咱们也不想给站长添加负担，毕竟这种站点咱们应该支持，让他长久维护下去，<strong>所以本期只分析逻辑和少部分代码，就不放完整代码了，如果有相关专业人士确实需要抓取数据做研究的，可以通过邮件联系我。</strong></p>
<h2><span id="rao-guo-wu-xian-debugger">绕过无限 debugger</span></h2>
<p>右键 F12，会提示右键被禁用，不要紧，使用快捷键 <code>Ctrl+Shift+i</code> 或者浏览器右上角，更多工具，开发者工具，照样能打开。</p>
<p><img src="https://cdn.itbob.cn/img/article/044/01.png" alt="01.png"></p>
<h3><span id="fang-fa-yi">方法一</span></h3>
<p>打开控制台后会进入第一个无限 debugger，往上跟一个栈，可以看到一个 try-catch 语句，你下断点会发现他会一直走 catch，调用 <code>setTimeout()</code> 方法，该方法用于在指定的毫秒数后调用函数或计算表达式，注意上面，是将 debugger 传递给了构造方法 constructor，所以这里我们有两种方法过掉 debugger，Hook 掉 constructor 或 setTimeout 都可以。</p>
<p><img src="https://cdn.itbob.cn/img/article/044/02.png" alt="02.png"></p>
<pre><code class="hljs javascript"><span class="hljs-comment">// 两种 Hook 任选一中</span>
<span class="hljs-comment">// Hook 构造方法</span>
<span class="hljs-built_in">Function</span>.prototype.constructor_ = <span class="hljs-built_in">Function</span>.prototype.constructor;
<span class="hljs-built_in">Function</span>.prototype.constructor = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a</span>) </span>&#123;
    <span class="hljs-keyword">if</span>(a == <span class="hljs-string">&quot;debugger&quot;</span>) &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span>&#123;&#125;;
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Function</span>.prototype.constructor_(a);
&#125;;

<span class="hljs-comment">// Hook setTimeout</span>
<span class="hljs-keyword">var</span> setTimeout_ = <span class="hljs-built_in">setTimeout</span>
<span class="hljs-keyword">var</span> <span class="hljs-built_in">setTimeout</span> = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">func, time</span>)</span>&#123;
    <span class="hljs-keyword">if</span> (func == txsdefwsw)&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;&#125;;
    &#125;
    <span class="hljs-keyword">return</span> setTimeout_(func, time)
&#125;</code></pre>
<p>然后就来到了第二个无限 debugger，同样跟栈，发现有个 setInterval 定时器和构造方法 constructor，类似的，我们 Hook 掉 constructor 或 setInterval 都可以。注意：定时器这里还检测了窗口高宽，即便是你过了 constructor 或 setInterval，如果不把开发者工具单独拿出来也是不行的，会不断输出“检测到非法调试”。</p>
<p><img src="https://cdn.itbob.cn/img/article/044/03.png" alt="03.png"></p>
<pre><code class="hljs javascript"><span class="hljs-comment">// Hook setInterval</span>
<span class="hljs-keyword">var</span> setInterval_ = <span class="hljs-built_in">setInterval</span>
<span class="hljs-built_in">setInterval</span> = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">func, time</span>)</span>&#123;
    <span class="hljs-keyword">if</span> (time == <span class="hljs-number">2000</span>) &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;&#125;;
    &#125;
    <span class="hljs-keyword">return</span> setInterval_(func, time)
&#125;</code></pre>
<p>我们观察到，其实这两个无限 debugger 都可以 Hook 构造方法来过掉，所以直接 Fiddler 注入该 Hook 构造方法的代码即可：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/04.png" alt="04.png"></p>
<h3><span id="fang-fa-er">方法二</span></h3>
<p>在我们遇到第二个无限 debugger 的时候，还可以直接跟栈到一个 city_realtime.php 的页面，里面有两个 eval 语句，执行第一个 eval 里面的语句你就会发现正是前面我们在 VM 虚拟机里面看到的 debugger 代码，所以这里理论上可以直接替换掉这个页面，去掉 eval 语句，就不会有无限 debugger 了，但是先告诉你，现在不行了，因为里面有加载了某个 JS，这个 JS 在后面加密解密中会用到，但是这个 JS 是动态的，每10分钟就会改变，我们后面还要通过此页面来获取动态的 JS，所以是不能替换的！这里只是提一下这个思路！</p>
<p><img src="https://cdn.itbob.cn/img/article/044/05.png" alt="05.png"></p>
<p><img src="https://cdn.itbob.cn/img/article/044/06.png" alt="06.png"></p>
<h3><span id="fang-fa-san">方法三</span></h3>
<p>当然，这里还有一种最简单的方法，直接右键选择 Never pause here，永不在此处断下即可，同样还需要把开发者工具窗口单独拿出来，不然会一直输出“检测到非法调试”。</p>
<p><img src="https://cdn.itbob.cn/img/article/044/07.png" alt="07.png"></p>
<h2><span id="zhua-bao-fen-xi">抓包分析</span></h2>
<p>我们在实时监控页面，顺便点击查询一个城市，可以看到请求的 Form Data 和返回的数据都是加密的，如下图所示：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/08.png" alt="08.png"></p>
<h2><span id="jia-mi-ru-kou">加密入口</span></h2>
<p>由于是 XHR，所以我们直接跟栈，很容易找到加密的位置：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/09.png" alt="09.png"></p>
<p><img src="https://cdn.itbob.cn/img/article/044/10.png" alt="10.png"></p>
<p>可以看到传递的 data 键值对：<code>&#123;hXM8NDFHN: p7crXYR&#125;</code>，键在这个 JS 里是写死的，值是通过一个方法 <code>pU14VhqrofroULds()</code> 得到的，这个方法需要传递两个参数，第一个是定值 GETDATA，第二个就是城市名称，我们再跟进看看这个方法是啥：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/11.png" alt="11.png"></p>
<p>一些 appId、时间戳、城市等参数，做了一些 MD5、base64 的操作，返回的 param 就是我们要的值了。看起来不难，我们再找找返回的加密数据是如何解密的，我们注意到 ajax 请求有个 success 关键字，我们即便是不懂 JS 逻辑，也可以猜到应该是请求成功后的处理操作吧，如下图所示：传进来的 dzJMI 就是返回的加密的数据，经过 <code>db0HpCYIy97HkHS7RkhUn()</code> 方法后，就解密成功了：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/12.png" alt="12.png"></p>
<p>跟进 <code>db0HpCYIy97HkHS7RkhUn()</code> 方法，可以看到是 AES+DES+BASE64 解密，传入的密钥 key 和偏移量 iv 都在头部有定义：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/13.png" alt="13.png"></p>
<p><img src="https://cdn.itbob.cn/img/article/044/14.png" alt="14.png"></p>
<h2><span id="dong-tai-js">动态 JS</span></h2>
<p>经过以上分析后，我们加密解密的逻辑都搞定了，但是你多调试一下就会发现，这一个加密解密的 JS 是动态变化的，定义的密钥 key 和偏移量 iv 都是隔段时间就会改变的，如果你在这段代码里下断点，停留时间过长，突然发现断点失效无法断下了，那就是 JS 变了，当前代码已经失效了。</p>
<p>我们随便薅两个不同的 JS 下来（提示：JS 每隔10分钟会变化，后文有详细分析），利用 PyCharm 的文件对比功能（依次选择 View - Compare With）可以总结出以下几个变化的地方（变量名的变化不算）：</p>
<ol>
<li>开头的8个参数的值：两个 aes key 和 iv，两个 des key 和 iv；</li>
</ol>
<p><img src="https://cdn.itbob.cn/img/article/044/15.png" alt="15.png"></p>
<ol start="2">
<li>生成加密的 param 时，appId 是变化的，最后的加密分为 AES、DES 和没有加密，三种情况（这里是最容易忽略的地方，这里没有注意到，请求可能会提示 appId 无效的情况）：</li>
</ol>
<p><img src="https://cdn.itbob.cn/img/article/044/16.png" alt="16.png"></p>
<ol start="3">
<li>最后发送请求时，data 键值对，其中的键也是变化的：</li>
</ol>
<p><img src="https://cdn.itbob.cn/img/article/044/17.png" alt="17.png"></p>
<p>变化的地方我们找到了，那我们怎么获取这个 JS 呢？因为这个 JS 的在 VM 虚拟机里，所以我们还要找到它的源头，是从哪里来的，我们抓包可以看到一个比较特殊的 JS，类似于 encrypt_xxxxxx.js，看这取名就知道不简单，返回的是一段 eval 包裹的代码：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/18.png" alt="18.png"></p>
<p>对于 eval 我们已经很熟悉了，直接去掉 eval，让他执行一下，就可以看到正是我们需要的那段 JS：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/19.png" alt="19.png"></p>
<p>这里有个小细节，如果你使用控制台，会发现它一直在打印 img 标签，影响我们的输入，这里可以直接跟进去下断点暂时阻止他运行就行了，不需要做其他操作浪费时间：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/20.png" alt="20.png"></p>
<p>你以为到这里就差不多搞定了？错了，同样的这个 encrypt_xxxxxx.js 也藏有玄机：</p>
<ol>
<li>encrypt_xxxxxx.js 的名称是动态的，后面的 v 值是秒级时间戳，隔600秒，也就是十分钟就会改变，这个 JS 可以在 city_realtime.php 页面找到，还记得我们前面说过的绕过无限 debugger 不能替换此页面吗？我们要通过此页面来获取动态的 JS，所以是不能替换的！</li>
</ol>
<p><img src="https://cdn.itbob.cn/img/article/044/21.png" alt="21.png"></p>
<p><img src="https://cdn.itbob.cn/img/article/044/22.png" alt="22.png"></p>
<ol start="2">
<li>encrypt_xxxxxx.js 返回的 JS，并不是所有的执行一遍 eval 就能得到明文代码了，它是 eval 和 base64 相结合的，第一遍都是 eval，但是后面就说不定了，有可能直接出结果，有可能需要 base64，有可能 base64 两遍，有可能两遍 base64 之后还要再 eval，总之，除了第一遍是 eval 以外，后面是否需要 base64 和 eval，以及需要的次数和先后顺序，都是不确定的！举几个例子：</li>
</ol>
<p><img src="https://cdn.itbob.cn/img/article/044/23.png" alt="23.png"></p>
<p><img src="https://cdn.itbob.cn/img/article/044/24.png" alt="24.png"></p>
<p><img src="https://cdn.itbob.cn/img/article/044/25.png" alt="25.png"></p>
<p>这里可能有人会问，你怎么看出来那是 base64 呢？很简单，直接在网站页面的控制台里输入 <code>dswejwehxt</code>，点击去看这个函数，就是 base64：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/26.png" alt="26.png"></p>
<p>那么针对 encrypt_xxxxxx.js 内容不确定的情况，我们可以写一个方法，获取到 encrypt_xxxxxx.js 后，需要执行 eval 就执行 eval，需要执行 base64 就执行 base64，直到没有 eval 和 base64 即可，可以分别用字符串 <code>eval(function</code> 和 <code>dswejwehxt(</code> 来判断是否需要 eval 和 base64（当然也有其他方式，比如 <code>()</code> 的个数等），示例代码如下所示：</p>
<pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_decrypted_js</span>(<span class="hljs-params">encrypted_js_url</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    :param encrypted_js_url: encrypt_xxxxxx.js 的地址</span>
<span class="hljs-string">    :return: 解密后的 JS</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    decrypted_js = requests.get(url=encrypted_js_url, headers=headers).text
    flag = <span class="hljs-literal">True</span>
    <span class="hljs-keyword">while</span> flag:
        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;eval(function&quot;</span> <span class="hljs-keyword">in</span> decrypted_js:
            <span class="hljs-comment"># 需要执行 eval</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;需要执行 eval！&quot;</span>)
            replace_js = decrypted_js.replace(<span class="hljs-string">&quot;eval(function&quot;</span>, <span class="hljs-string">&quot;(function&quot;</span>)
            decrypted_js = execjs.<span class="hljs-built_in">eval</span>(replace_js)
        <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;dswejwehxt(&quot;</span> <span class="hljs-keyword">in</span> decrypted_js:
            <span class="hljs-comment"># 需要 base64 解码</span>
            base64_num = decrypted_js.count(<span class="hljs-string">&quot;dswejwehxt(&quot;</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;需要 %s 次 base64 解码！&quot;</span> % base64_num)
            decrypted_js = re.findall(<span class="hljs-string">r&quot;\(&#x27;(.*?)&#x27;\)&quot;</span>, decrypted_js)[<span class="hljs-number">0</span>]
            num = <span class="hljs-number">0</span>
            <span class="hljs-keyword">while</span> base64_num &gt; num:
                decrypted_js = base64.b64decode(decrypted_js).decode()
                num += <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 得到明文</span>
            flag = <span class="hljs-literal">False</span>
    <span class="hljs-comment"># print(decrypted_js)</span>
    <span class="hljs-keyword">return</span> decrypted_js</code></pre>
<h2><span id="ben-di-gai-xie">本地改写</span></h2>
<p>通过以上函数我们就拿到了动态的 JS 了，那么我们可以直接执行拿回来的 JS 吗？当然是不可以的，你可以自己本地执行一下，可以发现里面的 CryptoJS、Base64、hex_md5 都需要补齐才行，所以到这里我们就有两种做法：</p>
<ol>
<li>拿到解密后的动态 JS 后，动态 JS 和我们自己写的 Base64、hex_md5 等方法组成新的 JS 代码，执行新的 JS 代码拿到参数，这里还需要注意因为里面的其他方法名都是动态的，所以你还得想办法匹配到正确的方法名来调用才行，所以这种方法个人感觉还是稍微有点儿麻烦的；</li>
<li>我们本地自己写一个 JS，拿到解密后的动态 JS 后，把里面的 key、iv、appId、data 键名、param 是否需要 AES 或 DES 加密，这些信息都匹配出来，然后传给我们自己写的 JS，调用我们自己的方法拿到加密结果。</li>
</ol>
<p>虽然两种方法都很麻烦，但暂时也想不到更好的解决方法了，有比较好的想法的朋友可以留言说一说。</p>
<p>以第二种方法为例，我们本地的 JS 示例（main.js）：</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">var</span> CryptoJS = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;crypto-js&quot;</span>);

<span class="hljs-keyword">var</span> BASE64 = &#123;
    <span class="hljs-attr">encrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text</span>) </span>&#123;
        <span class="hljs-keyword">return</span> CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(text))
    &#125;,
    <span class="hljs-attr">decrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text</span>) </span>&#123;
        <span class="hljs-keyword">return</span> CryptoJS.enc.Base64.parse(text).toString(CryptoJS.enc.Utf8)
    &#125;
&#125;;

<span class="hljs-keyword">var</span> DES = &#123;
    <span class="hljs-attr">encrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text, key, iv</span>) </span>&#123;
        <span class="hljs-keyword">var</span> secretkey = (CryptoJS.MD5(key).toString()).substr(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
        <span class="hljs-keyword">var</span> secretiv = (CryptoJS.MD5(iv).toString()).substr(<span class="hljs-number">24</span>, <span class="hljs-number">8</span>);
        secretkey = CryptoJS.enc.Utf8.parse(secretkey);
        secretiv = CryptoJS.enc.Utf8.parse(secretiv);
        <span class="hljs-keyword">var</span> result = CryptoJS.DES.encrypt(text, secretkey, &#123;
            <span class="hljs-attr">iv</span>: secretiv,
            <span class="hljs-attr">mode</span>: CryptoJS.mode.CBC,
            <span class="hljs-attr">padding</span>: CryptoJS.pad.Pkcs7
        &#125;);
        <span class="hljs-keyword">return</span> result.toString();
    &#125;,
    <span class="hljs-attr">decrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text, key, iv</span>) </span>&#123;
        <span class="hljs-keyword">var</span> secretkey = (CryptoJS.MD5(key).toString()).substr(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
        <span class="hljs-keyword">var</span> secretiv = (CryptoJS.MD5(iv).toString()).substr(<span class="hljs-number">24</span>, <span class="hljs-number">8</span>);
        secretkey = CryptoJS.enc.Utf8.parse(secretkey);
        secretiv = CryptoJS.enc.Utf8.parse(secretiv);
        <span class="hljs-keyword">var</span> result = CryptoJS.DES.decrypt(text, secretkey, &#123;
            <span class="hljs-attr">iv</span>: secretiv,
            <span class="hljs-attr">mode</span>: CryptoJS.mode.CBC,
            <span class="hljs-attr">padding</span>: CryptoJS.pad.Pkcs7
        &#125;);
        <span class="hljs-keyword">return</span> result.toString(CryptoJS.enc.Utf8);
    &#125;
&#125;;

<span class="hljs-keyword">var</span> AES = &#123;
    <span class="hljs-attr">encrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text, key, iv</span>) </span>&#123;
        <span class="hljs-keyword">var</span> secretkey = (CryptoJS.MD5(key).toString()).substr(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>);
        <span class="hljs-keyword">var</span> secretiv = (CryptoJS.MD5(iv).toString()).substr(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
        secretkey = CryptoJS.enc.Utf8.parse(secretkey);
        secretiv = CryptoJS.enc.Utf8.parse(secretiv);
        <span class="hljs-keyword">var</span> result = CryptoJS.AES.encrypt(text, secretkey, &#123;
            <span class="hljs-attr">iv</span>: secretiv,
            <span class="hljs-attr">mode</span>: CryptoJS.mode.CBC,
            <span class="hljs-attr">padding</span>: CryptoJS.pad.Pkcs7
        &#125;);
        <span class="hljs-keyword">return</span> result.toString();
    &#125;,
    <span class="hljs-attr">decrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">text, key, iv</span>) </span>&#123;
        <span class="hljs-keyword">var</span> secretkey = (CryptoJS.MD5(key).toString()).substr(<span class="hljs-number">16</span>, <span class="hljs-number">16</span>);
        <span class="hljs-keyword">var</span> secretiv = (CryptoJS.MD5(iv).toString()).substr(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>);
        secretkey = CryptoJS.enc.Utf8.parse(secretkey);
        secretiv = CryptoJS.enc.Utf8.parse(secretiv);
        <span class="hljs-keyword">var</span> result = CryptoJS.AES.decrypt(text, secretkey, &#123;
            <span class="hljs-attr">iv</span>: secretiv,
            <span class="hljs-attr">mode</span>: CryptoJS.mode.CBC,
            <span class="hljs-attr">padding</span>: CryptoJS.pad.Pkcs7
        &#125;);
        <span class="hljs-keyword">return</span> result.toString(CryptoJS.enc.Utf8);
    &#125;
&#125;;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDecryptedData</span>(<span class="hljs-params">data, AES_KEY_1, AES_IV_1, DES_KEY_1, DES_IV_1</span>) </span>&#123;
    data = AES.decrypt(data, AES_KEY_1, AES_IV_1);
    data = DES.decrypt(data, DES_KEY_1, DES_IV_1);
    data = BASE64.decrypt(data);
    <span class="hljs-keyword">return</span> data;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ObjectSort</span>(<span class="hljs-params">obj</span>) </span>&#123;
    <span class="hljs-keyword">var</span> newObject = &#123;&#125;;
    <span class="hljs-built_in">Object</span>.keys(obj).sort().map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>&#123;
        newObject[key] = obj[key];
    &#125;);
    <span class="hljs-keyword">return</span> newObject;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequestParam</span>(<span class="hljs-params">method, obj, appId</span>) </span>&#123;
    <span class="hljs-keyword">var</span> clienttype = <span class="hljs-string">&#x27;WEB&#x27;</span>;
    <span class="hljs-keyword">var</span> timestamp = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime()
    <span class="hljs-keyword">var</span> param = &#123;
        <span class="hljs-attr">appId</span>: appId,
        <span class="hljs-attr">method</span>: method,
        <span class="hljs-attr">timestamp</span>: timestamp,
        <span class="hljs-attr">clienttype</span>: clienttype,
        <span class="hljs-attr">object</span>: obj,
        <span class="hljs-attr">secret</span>: CryptoJS.MD5(appId + method + timestamp + clienttype + <span class="hljs-built_in">JSON</span>.stringify(ObjectSort(obj))).toString()
    &#125;;
    param = BASE64.encrypt(<span class="hljs-built_in">JSON</span>.stringify(param));
    <span class="hljs-keyword">return</span> param;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequestAESParam</span>(<span class="hljs-params">requestMethod, requestCity, appId, AES_KEY_2, AES_IV_2</span>)</span>&#123;
    <span class="hljs-keyword">var</span> param = getRequestParam(requestMethod, requestCity, appId);
    <span class="hljs-keyword">return</span> AES.encrypt(param, AES_KEY_2, AES_IV_2);
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getRequestDESParam</span>(<span class="hljs-params">requestMethod, requestCity, appId, DES_KEY_2, DES_IV_2</span>)</span>&#123;
    <span class="hljs-keyword">var</span> param = getRequestParam(requestMethod, requestCity, appId);
    <span class="hljs-keyword">return</span> DES.encrypt(param, DES_KEY_2, DES_IV_2);
&#125;</code></pre>
<p>我们匹配 JS 里面的各项参数的 Python 代码示例（匹配8个 key、iv 值、appId 和 param 的加密方式）：</p>
<pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_key_iv_appid</span>(<span class="hljs-params">decrypted_js</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    :param decrypted_js: 解密后的 encrypt_xxxxxx.js</span>
<span class="hljs-string">    :return: 请求必须的一些参数</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    key_iv = re.findall(<span class="hljs-string">r&#x27;const.*?&quot;(.*?)&quot;;&#x27;</span>, decrypted_js)
    app_id = re.findall(<span class="hljs-string">r&quot;var appId.*?&#x27;(.*?)&#x27;;&quot;</span>, decrypted_js)
    request_data_name = re.findall(<span class="hljs-string">r&quot;aqistudyapi.php.*?data.*?&#123;(.*?):&quot;</span>, decrypted_js, re.DOTALL)

    <span class="hljs-comment"># 判断 param 是 AES 加密还是 DES 加密还是没有加密</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;AES.encrypt(param&quot;</span> <span class="hljs-keyword">in</span> decrypted_js:
        request_param_encrypt = <span class="hljs-string">&quot;AES&quot;</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-string">&quot;DES.encrypt(param&quot;</span> <span class="hljs-keyword">in</span> decrypted_js:
        request_param_encrypt = <span class="hljs-string">&quot;DES&quot;</span>
    <span class="hljs-keyword">else</span>:
        request_param_encrypt = <span class="hljs-string">&quot;NO&quot;</span>

    key_iv_appid = &#123;
        <span class="hljs-comment"># key 和 iv 的位置和原来 js 里的是一样的</span>
        <span class="hljs-string">&quot;aes_key_1&quot;</span>: key_iv[<span class="hljs-number">0</span>],
        <span class="hljs-string">&quot;aes_iv_1&quot;</span>: key_iv[<span class="hljs-number">1</span>],
        <span class="hljs-string">&quot;aes_key_2&quot;</span>: key_iv[<span class="hljs-number">2</span>],
        <span class="hljs-string">&quot;aes_iv_2&quot;</span>: key_iv[<span class="hljs-number">3</span>],
        <span class="hljs-string">&quot;des_key_1&quot;</span>: key_iv[<span class="hljs-number">4</span>],
        <span class="hljs-string">&quot;des_iv_1&quot;</span>: key_iv[<span class="hljs-number">5</span>],
        <span class="hljs-string">&quot;des_key_2&quot;</span>: key_iv[<span class="hljs-number">6</span>],
        <span class="hljs-string">&quot;des_iv_2&quot;</span>: key_iv[<span class="hljs-number">7</span>],
        <span class="hljs-string">&quot;app_id&quot;</span>: app_id[<span class="hljs-number">0</span>],
        <span class="hljs-comment"># 发送请求的 data 的键名</span>
        <span class="hljs-string">&quot;request_data_name&quot;</span>: request_data_name[<span class="hljs-number">0</span>].strip(),
        <span class="hljs-comment"># 发送请求的 data 值需要哪种加密</span>
        <span class="hljs-string">&quot;request_param_encrypt&quot;</span>: request_param_encrypt
    &#125;
    <span class="hljs-comment"># print(key_iv_appid)</span>
    <span class="hljs-keyword">return</span> key_iv_appid</code></pre>
<p>我们发送请求以及解密返回值的 Python 代码示例（以北京为例）：</p>
<pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">key_iv_appid</span>):</span>
    <span class="hljs-string">&quot;&quot;&quot;</span>
<span class="hljs-string">    :param key_iv_appid: get_key_iv_appid() 方法返回的值</span>
<span class="hljs-string">    &quot;&quot;&quot;</span>
    request_method = <span class="hljs-string">&quot;GETDATA&quot;</span>
    request_city = &#123;<span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;北京&quot;</span>&#125;
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;main.js&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:
        execjs_ = execjs.<span class="hljs-built_in">compile</span>(f.read())

    <span class="hljs-comment"># 根据不同加密方式调用不同方法获取请求加密的 param 参数</span>
    request_param_encrypt = key_iv_appid[<span class="hljs-string">&quot;request_param_encrypt&quot;</span>]
    <span class="hljs-keyword">if</span> request_param_encrypt == <span class="hljs-string">&quot;AES&quot;</span>:
        param = execjs_.call(
            <span class="hljs-string">&#x27;getRequestAESParam&#x27;</span>, request_method, request_city,
            key_iv_appid[<span class="hljs-string">&quot;app_id&quot;</span>], key_iv_appid[<span class="hljs-string">&quot;aes_key_2&quot;</span>], key_iv_appid[<span class="hljs-string">&quot;aes_iv_2&quot;</span>]
        )
    <span class="hljs-keyword">elif</span> request_param_encrypt == <span class="hljs-string">&quot;DES&quot;</span>:
        param = execjs_.call(
            <span class="hljs-string">&#x27;getRequestDESParam&#x27;</span>, request_method, request_city,
            key_iv_appid[<span class="hljs-string">&quot;app_id&quot;</span>], key_iv_appid[<span class="hljs-string">&quot;des_key_2&quot;</span>], key_iv_appid[<span class="hljs-string">&quot;des_iv_2&quot;</span>]
        )
    <span class="hljs-keyword">else</span>:
        param = execjs_.call(<span class="hljs-string">&#x27;getRequestParam&#x27;</span>, request_method, request_city, key_iv_appid[<span class="hljs-string">&quot;app_id&quot;</span>])
    data = &#123;
        key_iv_appid[<span class="hljs-string">&quot;request_data_name&quot;</span>]: param
    &#125;
    response = requests.post(url=aqistudy_api, headers=headers, data=data).text
    <span class="hljs-comment"># print(response)</span>

    <span class="hljs-comment"># 对获取的加密数据解密</span>
    decrypted_data = execjs_.call(
        <span class="hljs-string">&#x27;getDecryptedData&#x27;</span>, response,
        key_iv_appid[<span class="hljs-string">&quot;aes_key_1&quot;</span>], key_iv_appid[<span class="hljs-string">&quot;aes_iv_1&quot;</span>],
        key_iv_appid[<span class="hljs-string">&quot;des_key_1&quot;</span>], key_iv_appid[<span class="hljs-string">&quot;des_iv_1&quot;</span>]
    )
    <span class="hljs-built_in">print</span>(json.loads(decrypted_data))</code></pre>
<p>运行结果，成功请求并解密返回值：</p>
<p><img src="https://cdn.itbob.cn/img/article/044/27.png" alt="27.png"></p>

            </div>
        </article>
    </div>
    <br>
    
        <div class="next-prev-post">
            
                <div class="prev-post">
                    <div class="prev gt-c-content-color-first">
                        上一篇：<a href="/article/045/" 
                            class="post-title gt-a-link">CTF&爬虫：掌握这些特征，一秒识别密文加密方式</a>
                    </div>
                </div>
            
            
                <div class="next-post">
                    <div class="next gt-c-content-color-first">
                        下一篇：<a href="/article/043/" 
                            class="post-title gt-a-link">WebSocket 协议爬虫，智慧树扫码登录案例分析</a>
                    </div>
                </div>
            
        </div>
    
    

    
    <script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css">
    <script src="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>

    <div id="gitalk-container"></div>

    <script>
    var gitalk = new Gitalk({
        clientID: 'd19a84b9d9a2ddb2c6b9',
        clientSecret: 'cec9feae5129a6106edc68ce06d167be8eb06021',
        repo: 'trhx.github.io',
        owner: 'TRHX',
        admin: ['TRHX'],
        id: md5(location.pathname),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false       // Facebook-like distraction free mode
    });
    gitalk.render('gitalk-container');
    </script>


    
</div>

                <div class="site-footer gt-c-content-color-first">
    <div class="footer-main">
        <!-- 建议保留版权信息或者添加主题信息到友链，感谢您的理解 -->
        <!-- 文件位置：layout/_includes/footer.ejs -->
        <!-- <span style="text-align: right; float: right;">
            Theme 
            <a href="https://github.com/renbaoshuo/hexo-theme-pure" target="_blank">Pure</a>
             | Powered by
            <a href="https://hexo.io" target="_blank">Hexo</a>
        </span>
        <span style="text-align: left;"></span> -->
        <span>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fas fa-user"></i> UV
                </span>
                <span class="badge-value bg-pink" id="busuanzi_value_site_uv"></span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fas fa-user-plus"></i> PV
                </span>
                <span class="badge-value bg-blue" id="busuanzi_value_site_pv"></span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fa fa-keyboard"></i> Word Count
                </span>
                <span class="badge-value bg-firebrick post-count">314.6k</span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fa fa-cog fa-spin"></i> Powered by
                </span>
                <span class="badge-value bg-brightgreen"><a href="https://hexo.io" target="_blank">Hexo</a></span>
            </div>
            <div class="itbob-github-badge">
                <span class="badge-subject">
                    <i class="fa fa-paper-plane"></i> Theme
                </span>
                <span class="badge-value bg-orange"><a href="https://github.com/renbaoshuo/hexo-theme-pure" target="_blank">Pure</a></span>
            </div>
        </span>
        <br/>
        <br/>

        <span style="text-align: center; float: center;">
            Copyright <i class="fa fa-copyright"></i> 2018 - <script>document.write(new Date().getFullYear());</script> <a href="https://www.itbob.cn/" target="_blank">ITBOB.CN</a> 丨
            <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">
                <i class="fab fa-creative-commons"></i>
                <i class="fab fa-creative-commons-by"></i>
                <i class="fab fa-creative-commons-nc"></i>
                <i class="fab fa-creative-commons-nd"></i>
            </a> 丨
            <!-- <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a> 丨 -->
            <span id="sitetime">正在载入网站运行时间...</span>
            <script>
                function siteTime(){
                    window.setTimeout("siteTime()", 1000);
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth()+1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    /* 
                    Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
                    year - 作为date对象的年份，为4位年份值
                    month - 0-11之间的整数，做为date对象的月份
                    day - 1-31之间的整数，做为date对象的天数
                    hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
                    minutes - 0-59之间的整数，做为date对象的分钟数
                    seconds - 0-59之间的整数，做为date对象的秒数
                    microseconds - 0-999之间的整数，做为date对象的毫秒数
                    */
                    var t1 = Date.UTC(2018,08,10,17,38,00); //北京时间2018-8-10 17:38:00
                    var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
                    var diff = t2-t1;
                    var diffYears = Math.floor(diff/years);
                    var diffDays = Math.floor((diff/days)-diffYears*365);
                    var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
                    var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
                    var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
                    document.getElementById("sitetime").innerHTML="小破站已运行了 "
                    + "<font style='color:#FE3C65;font-weight:bold'>" + diffYears + "</font>" + " 年 "
                    + "<font style='color:#FFA500;font-weight:bold'>" + diffDays + "</font>" + " 天 "
                    + "<font style='color:#1DBF97;font-weight:bold'>" + diffHours + "</font>" + " 小时 "
                    + "<font style='color:#8A2BE2;font-weight:bold'>" + diffMinutes + "</font>" + " 分 "
                    + "<font style='color:#007EC6;font-weight:bold'>" + diffSeconds + "</font>" + " 秒 ";
                }
                siteTime();
            </script>
        </span>
        <br/>
        <br/>
        <span>
            <img src="https://cdn.itbob.cn/img/footer/icp.png" class="nofancybox" alt="ICP" style="width:auto; height:20px; margin-bottom:-4px"><a href="https://beian.miit.gov.cn/" target="_blank"> 鄂ICP备19003281号-7</a>丨
            <img src="https://cdn.itbob.cn/img/footer/moeicp.png" class="nofancybox" alt="MOE ICP" style="width:auto; height:18px; margin-bottom:-3.5px"><a href="https://icp.gov.moe/" target="_blank"> 萌ICP备20202022号</a>丨
            <img src="https://cdn.itbob.cn/img/footer/webify.png" class="nofancybox" alt="腾讯云开发 Webify" style="width:auto; height:25px; margin-bottom:-8px"><a href="https://webify.cloudbase.net/" target="_blank"> 云开发 Webify</a>丨
            <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank"><img src="https://cdn.itbob.cn/img/footer/upyun.png" class="nofancybox" alt="又拍云赞助云存储" style="width:auto; height:19px; margin-bottom:-4px"></a> 赞助CDN/COS服务丨
            <a href="https://www.foreverblog.cn/" target="_blank"><img src="https://cdn.itbob.cn/img/footer/foreverblog.png" class="nofancybox" alt="十年之约" style="width:auto; height:15px; margin-bottom:-2px"></a>
        </span>
    </div>
</div>

<!-- <div class="sidebar_wo" id="leimu">
    <img src="https://cdn.itbob.cn/img/footer/leimuA.png" class="nofancybox" alt="雷姆" 
    onmouseover="this.src='https://cdn.itbob.cn/img/footer/leimuB.png'" 
    onmouseout="this.src='https://cdn.itbob.cn/img/footer/leimuA.png'" title="回到底部">
</div>
<div class="sidebar_wo" id="lamu">
    <img src="https://cdn.itbob.cn/img/footer/lamuA.png" class="nofancybox" alt="雷姆" 
    onmouseover="this.src='https://cdn.itbob.cn/img/footer/lamuB.png'" 
    onmouseout="this.src='https://cdn.itbob.cn/img/footer/lamuA.png'" title="回到顶部">
</div> -->

<script>
    /* 拉姆蕾姆回到顶部或底部按钮 */
    $(function() {
        $("#leimu img").eq(0).click(function() {
            $("html,body").animate({scrollTop:$(document).height()},800);
            return false;
        });
        $("#lamu img").eq(0).click(function() {
            $("html,body").animate({scrollTop:0},800);
            return false;
        });
    });
</script>

            </div>
        </div>
        <!-- <a id="back-to-top" class="back-to-top show hl fa fa-arrow-up" href="javascript:void(0)" title="回到顶部"></a> -->
        <a id="back-to-top" class="back-to-top2" href="javascript:void(0)" title="回到顶部">
            <img class="nofancybox" src="https://cdn.itbob.cn/img/back_to_top.png"/>
        </a>
        <script>
            (function () {
                // When to show the scroll link
                // higher number = scroll link appears further down the page   
                var upperLimit = 100;
                
                // Our scroll link element
                var scrollElem = $('#back-to-top');
            
                // Scroll to top speed
                var scrollSpeed = 500;
            
                // Show and hide the scroll to top link based on scroll position   
                scrollElem.hide();
                $(window).scroll(function () {            
                    var scrollTop = $(document).scrollTop();       
                    if ( scrollTop > upperLimit ) {
                        $(scrollElem).stop().fadeTo(200, 1); // fade back in           
                    }else{       
                        $(scrollElem).stop().fadeTo(200, 0); // fade out
                    }
                });

                // Scroll to top animation on click
                $(scrollElem).click(function(){
                    $('html, body').animate({scrollTop:0}, scrollSpeed); return false;
                });
            })();
        </script>
    </body>
</html>